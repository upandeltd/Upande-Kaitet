[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-07-08 06:45:26.790185",
  "module": "Upande Kaitet",
  "name": "Rate based on Length",
  "script": "frappe.ui.form.on('Sales Order Item', {\n    custom_length(frm, cdt, cdn) {\n        let row = frappe.get_doc(cdt, cdn);\n\n        if (row.item_name && row.custom_length && frm.doc.price_list_currency && frm.doc.currency) {\n            // Primary fetch: current price list\n            fetch_price_from_list(frm, cdt, cdn, row.item_name, row.custom_length, frm.doc.selling_price_list, frm.doc.plc_conversion_rate, true);\n        }\n    }\n});\n\nfunction fetch_price_from_list(frm, cdt, cdn, item_name, length, price_list, conversion_rate, is_primary = false) {\n    frappe.call({\n        method: \"upande_kaitet.api.item_length_price.get_length_price\",\n        args: {\n            item_name: item_name,\n            length: length,\n            currency: frm.doc.price_list_currency,\n            price_list: price_list\n        },\n        callback: function (r) {\n            if (r.message) {\n                const base_currency = frm.doc.currency;\n                const rate_currency = frm.doc.price_list_currency;\n                const exchange_rate = conversion_rate || 1;\n\n                let converted_rate = flt(r.message);\n\n                if (rate_currency !== base_currency) {\n                    converted_rate = converted_rate * flt(exchange_rate);\n                }\n\n                frappe.model.set_value(cdt, cdn, 'price_list_rate', converted_rate);\n                frappe.model.set_value(cdt, cdn, 'base_price_list_rate', converted_rate);\n                frappe.model.set_value(cdt, cdn, 'stock_uom_rate', converted_rate);\n                frappe.model.set_value(cdt, cdn, 'amount', converted_rate * frappe.get_doc(cdt, cdn).qty);\n            } else if (is_primary) {\n                frappe.msgprint(\"No price found for this price list. Falling back to Standard Selling...\");\n                fetch_price_from_list(frm, cdt, cdn, item_name, length, \"Standard Selling\", 1, false);\n            } else {\n                // Fallback also failed\n                frappe.msgprint(\"No price found for the selected item, length, and currency even in Standard Selling.\");\n                frappe.model.set_value(cdt, cdn, 'price_list_rate', 0);\n            }\n        }\n    });\n}\n",
  "view": "Form"
 }
]