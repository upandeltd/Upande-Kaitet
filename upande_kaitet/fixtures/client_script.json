[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Tractor Inspection Checksheet",
  "enabled": 1,
  "modified": "2025-06-20 18:29:53.582815",
  "module": "Assets",
  "name": "Tractor Inspection Checksheet",
  "script": "frappe.ui.form.on('Tractor Inspection Checksheet', {\n    refresh: function(frm) {\n        if (frm.doc.__islocal) {\n            // Load abnormalities table\n            if (!frm.doc.abnormalities_log || frm.doc.abnormalities_log.length === 0) {\n                add_abnormality_rows(frm);\n            }\n\n            // Load frequency-specific items\n            if (frm.doc.frequency && (!frm.doc.inspection_items || frm.doc.inspection_items.length === 0)) {\n                load_inspection_items(frm);\n            }\n        }\n    },\n\n    frequency: function(frm) {\n        if (frm.doc.frequency) {\n            frm.clear_table('inspection_items');\n            load_inspection_items(frm);\n        }\n    }\n});\n\nfunction add_abnormality_rows(frm) {\n    const rows = [\n        { week: \"Abnormalities identified\" },\n        { week: \"Abnormalities corrected\" }\n    ];\n    rows.forEach(item => {\n        const row = frm.add_child('abnormalities_log');\n        row.week = item.week;\n        row.identified = 0;\n        row.corrected = 0;\n    });\n    frm.refresh_field('abnormalities_log');\n}\n\nfunction load_inspection_items(frm) {\n    const inspection_items = get_inspection_items_by_type(frm.doc.frequency);\n\n    inspection_items.forEach(item => {\n        const row = frm.add_child('inspection_items');\n        row.data = item.item;\n        row.notes = item.action_required;\n        row.status = '- Not Checked';\n        row.priority = item.priority || 'Medium';\n    });\n\n    frm.refresh_field('inspection_items');\n}\n\nfunction get_inspection_items_by_type(frequency) {\n    const items = {\n        'Daily': [\n            { item: \"Engine Oil Level\", action_required: \"Top up if low\", priority: \"High\" },\n            { item: \"Coolant Level\", action_required: \"Top up if low\", priority: \"High\" },\n            { item: \"Hydraulic Fluid Level\", action_required: \"Top up if low\", priority: \"High\" },\n            { item: \"Transmission Fluid Level\", action_required: \"Top up if low\", priority: \"High\" },\n            { item: \"Fuel Level\", action_required: \"Refuel if low\", priority: \"High\" },\n            { item: \"Lights and Indicators\", action_required: \"Replace bulbs if needed\", priority: \"Medium\" },\n            { item: \"Belts and Hoses\", action_required: \"Replace if necessary\", priority: \"High\" },\n            { item: \"Tires and Wheels\", action_required: \"Adjust pressure or replace if needed\", priority: \"High\" }\n        ],\n\n        'Weekly': [\n            { item: \"Air Filter\", action_required: \"Replace if necessary\", priority: \"Medium\" },\n            { item: \"Battery Condition\", action_required: \"Clean or replace if needed\", priority: \"High\" },\n            { item: \"Fuel Filter\", action_required: \"Replace if necessary\", priority: \"Medium\" },\n            { item: \"Grease Points\", action_required: \"Lubricate if needed\", priority: \"Medium\" }\n        ],\n\n        'Monthly': [\n            { item: \"Radiator and Cooling System\", action_required: \"Repair or replace if necessary\", priority: \"High\" },\n            { item: \"Steering and Suspension\", action_required: \"Investigate if necessary\", priority: \"High\" },\n            { item: \"Exhaust System\", action_required: \"Address issues if found\", priority: \"Medium\" },\n            { item: \"Transmission Filter\", action_required: \"Replace if needed\", priority: \"Medium\" },\n            { item: \"Brake System\", action_required: \"Replace or top up fluid if needed\", priority: \"Critical\" }\n        ],\n\n        'Quarterly': [\n            { item: \"Battery Electrolyte Level\", action_required: \"Top up with distilled water\", priority: \"High\" },\n            { item: \"Drive Belts\", action_required: \"Replace if needed\", priority: \"High\" },\n            { item: \"Fuel Lines and Connections\", action_required: \"Repair or replace if necessary\", priority: \"High\" }\n        ],\n\n        'Yearly': [\n            { item: \"Engine Compression\", action_required: \"Investigate and repair if necessary\", priority: \"High\" },\n            { item: \"Cooling System Flush\", action_required: \"Replace if necessary\", priority: \"High\" },\n            { item: \"Transmission Service\", action_required: \"Replace if needed\", priority: \"High\" },\n            { item: \"Brake Fluid Replacement\", action_required: \"Replace if needed\", priority: \"Critical\" }\n        ]\n    };\n\n    return items[frequency] || [];\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CFU Inspection Checksheet",
  "enabled": 1,
  "modified": "2025-06-21 23:22:49.244952",
  "module": "Upande Kaitet",
  "name": "CFU Inspection Checksheet",
  "script": "frappe.ui.form.on('CFU Inspection Checksheet', {\n    refresh: function(frm) {\n        if (frm.doc.__islocal) {\n            // Add abnormalities table rows if not already added\n            if (!frm.doc.abnormalities_log || frm.doc.abnormalities_log.length === 0) {\n                add_cfu_abnormality_rows(frm);\n            }\n\n            // Load inspection items if frequency is already selected\n            if (frm.doc.frequency && (!frm.doc.inspection_items || frm.doc.inspection_items.length === 0)) {\n                load_cfu_items(frm);\n            }\n        }\n    },\n\n    frequency: function(frm) {\n        if (frm.doc.frequency) {\n            frm.clear_table('inspection_items');\n            load_cfu_items(frm);\n        }\n    }\n});\n\n// Add abnormalities rows\nfunction add_cfu_abnormality_rows(frm) {\n    const rows = [\n        { week: \"Abnormalities identified\", identified: 0, corrected: 0 },\n        { week: \"Abnormalities corrected\", identified: 0, corrected: 0 }\n    ];\n    rows.forEach(row => {\n        const child = frm.add_child('abnormalities_log');\n        child.week = row.week;\n        child.identified = row.identified;\n        child.corrected = row.corrected;\n    });\n    frm.refresh_field('abnormalities_log');\n}\n\n// Load inspection items for selected frequency\nfunction load_cfu_items(frm) {\n    const frequency = frm.doc.frequency;\n    const checklist = get_cfu_items_by_frequency(frequency);\n\n    checklist.forEach(item => {\n        const row = frm.add_child('inspection_items');\n        row.equipment = item.equipment;\n        row.part_name = item.part_name;\n        row.parameter_checked = item.parameter_checked;\n        row.status = \"Not Checked\";\n        row.notes = item.notes || \"\";\n    });\n\n    frm.refresh_field('inspection_items');\n}\n\n// Define checklist items per frequency\nfunction get_cfu_items_by_frequency(frequency) {\n    const items = {\n        'Daily': [\n            { equipment: \"Fertilizer Mixing Tank\", part_name: \"Gate valve\", parameter_checked: \"opening and closing\" },\n            { equipment: \"Fertilizer Mixing Tank\", part_name: \"Filters\", parameter_checked: \"cleaning\" },\n            { equipment: \"Fertilizer Mixing Tank\", part_name: \"Piping\", parameter_checked: \"check for leakage\" },\n            { equipment: \"Priva system\", part_name: \"Dozing Gate valve\", parameter_checked: \"opening and closing\" },\n            { equipment: \"Priva system\", part_name: \"dozing tube\", parameter_checked: \"suctioning within range\" },\n            { equipment: \"Priva system\", part_name: \"Pressure gauge\", parameter_checked: \"dial gauge permissible limits\" },\n            { equipment: \"Priva system\", part_name: \"\", parameter_checked: \"clean and visible\" },\n            { equipment: \"Priva system\", part_name: \"Piping system\", parameter_checked: \"check for leakage\" },\n            { equipment: \"Priva system\", part_name: \"Vacuum pump\", parameter_checked: \"overheating\" },\n            { equipment: \"Priva system\", part_name: \"\", parameter_checked: \"check for leakage\" },\n            { equipment: \"Amiad system\", part_name: \"screen Indicator\", parameter_checked: \"check the gauge\" },\n            { equipment: \"Amiad system\", part_name: \"Pressure gauge\", parameter_checked: \"dial gauge permissible limits\" },\n            { equipment: \"Amiad system\", part_name: \"Control panel\", parameter_checked: \"check display lights\" },\n            { equipment: \"Amiad system\", part_name: \"structure box\", parameter_checked: \"check for leakage\" },\n            { equipment: \"Amiad system\", part_name: \"Amiad housing\", parameter_checked: \"Cleaning\" },\n            { equipment: \"Amiad system\", part_name: \"Pipe connections\", parameter_checked: \"check for leakage\" },\n            { equipment: \"Water pumps\", part_name: \"Metalic Seal\", parameter_checked: \"check for leakage\" },\n            { equipment: \"Water pumps\", part_name: \"Pressure gauge\", parameter_checked: \"dial gauge permissible limits\" },\n            { equipment: \"Water pumps\", part_name: \"Air Release valves\", parameter_checked: \"check for leakage\" },\n            { equipment: \"Main piping system\", part_name: \"Pipes\", parameter_checked: \"cleaning\" },\n            { equipment: \"Main piping system\", part_name: \"\", parameter_checked: \"check for leakage\" },\n            { equipment: \"Main piping system\", part_name: \"GH Gate Valves\", parameter_checked: \"opening and closing\" }\n        ],\n\n        'Weekly': [\n            { equipment: \"Priva system\", part_name: \"filters\", parameter_checked: \"cleaning\" },\n            { equipment: \"Priva system\", part_name: \"Non return valves\", parameter_checked: \"spring tension in place\" },\n            { equipment: \"Priva system\", part_name: \"\", parameter_checked: \"cleaning\" },\n            { equipment: \"Priva system\", part_name: \"Piping system\", parameter_checked: \"cleaning\" },\n            { equipment: \"Amiad system\", part_name: \"Bolts & nuts\", parameter_checked: \"Tightening\" },\n            { equipment: \"Amiad system\", part_name: \"screen filter\", parameter_checked: \"cleaning\" },\n            { equipment: \"Mixing valve\", part_name: \"Bolts & nuts\", parameter_checked: \"Tightening\" },\n            { equipment: \"Water pumps\", part_name: \"Air Release Valve\", parameter_checked: \"cleaning\" }\n        ],\n\n        'Monthly': [\n            { equipment: \"Priva system\", part_name: \"pH & EC sensors\", parameter_checked: \"calibration\" },\n            { equipment: \"Amiad system\", part_name: \"Main shaft\", parameter_checked: \"Lubrication\" },\n            { equipment: \"Water pumps\", part_name: \"Bolts & nuts\", parameter_checked: \"Tightening\" },\n            { equipment: \"Main piping system\", part_name: \"Bolts & nuts\", parameter_checked: \"Tightening\" }\n        ],\n\n        'Quarterly': [\n            { equipment: \"Main piping system\", part_name: \"Water meter\", parameter_checked: \"cleaning\" },\n            { equipment: \"Main piping system\", part_name: \"\", parameter_checked: \"propelling\" }\n        ]\n    };\n\n    return items[frequency] || [];\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Packhouse Equipment and Machine AM Checklist",
  "enabled": 1,
  "modified": "2025-06-23 08:53:42.166125",
  "module": "Upande Kaitet",
  "name": "Packhouse Equipment and Machine AM Checklist",
  "script": "frappe.ui.form.on('Packhouse Equipment and Machine AM Checklist', {\n    refresh: function(frm) {\n        if (frm.doc.__islocal && frm.doc.equipment_type) {\n            if (!frm.doc.inspection_items || frm.doc.inspection_items.length === 0) {\n                load_equipment_items(frm);\n            }\n        }\n    },\n\n    equipment_type: function(frm) {\n        frm.clear_table('inspection_items');\n        load_equipment_items(frm);\n    }\n});\n\nfunction load_equipment_items(frm) {\n    const items = get_items_by_equipment_type(frm.doc.equipment_type);\n\n    items.forEach(item => {\n        const row = frm.add_child('inspection_items');\n        row.equipment = item.equipment;\n        row.part_name = item.part_name;\n        row.parameter_checked = item.parameter_checked;\n        row.status = \"Not Checked\";\n        row.notes = item.notes || \"\";\n    });\n\n    frm.refresh_field('inspection_items');\n}\n\nfunction get_items_by_equipment_type(equipment_type) {\n    const checklist = {\n        \"Strapping Machine\": [\n            { equipment: \"Strapping Machine\", part_name: \"Body\", parameter_checked: \"Clean inside & outside\" },\n            { equipment: \"Strapping Machine\", part_name: \"V-Belt\", parameter_checked: \"Check for wear and tear\" },\n            { equipment: \"Strapping Machine\", part_name: \"Tension Springs\", parameter_checked: \"Check if broken\" },\n            { equipment: \"Strapping Machine\", part_name: \"Feeder Guide\", parameter_checked: \"Clear from debris\" },\n            { equipment: \"Strapping Machine\", part_name: \"Gear Box Oil\", parameter_checked: \"Check if sufficient\" }\n            // Add all 15 here\n        ],\n        \"Electric Conveyor\": [\n            { equipment: \"Electric Conveyor\", part_name: \"Conveyor Belt\", parameter_checked: \"Check for wear and tear\" },\n            { equipment: \"Electric Conveyor\", part_name: \"Electric Motor\", parameter_checked: \"Wires terminated\" },\n            { equipment: \"Electric Conveyor\", part_name: \"Cooling Fan\", parameter_checked: \"Fan is working\" },\n            { equipment: \"Electric Conveyor\", part_name: \"Gearbox\", parameter_checked: \"Dust and oil-free\" }\n        ],\n        \"Cold Store\": [\n            { equipment: \"Cold Store\", part_name: \"Compressor\", parameter_checked: \"Dust & oil free\" },\n            { equipment: \"Cold Store\", part_name: \"Condensor\", parameter_checked: \"Dust & oil free\" },\n            { equipment: \"Cold Store\", part_name: \"Evaporator\", parameter_checked: \"Dust & oil free\" }\n            // Add more rows as needed\n        ]\n    };\n\n    return checklist[equipment_type] || [];\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Harvest",
  "enabled": 0,
  "modified": "2025-06-23 18:37:41.832002",
  "module": "Upande Kaitet",
  "name": "Restrict Bay to Alphabets",
  "script": "frappe.ui.form.on('Harvest', {\n    validate: function(frm) {\n        var field_value = frm.doc.bay;\n        if (field_value) {\n            // Convert to uppercase and set it back\n            field_value = field_value.toUpperCase();\n            frm.set_value('bay', field_value);\n            \n            // Check if it contains only alphabets and spaces\n            if (!/^[A-Z\\s]+$/.test(field_value)) {\n                frappe.msgprint(__('The field {0} can only contain alphabets.'), [frm.fields_dict.bay.label]);\n                frappe.validated = false; // Prevent saving the form\n            }\n        }\n    },\n    bay: function(frm) {\n        var field_value = frm.doc.bay;\n        if (field_value) {\n            // Convert to uppercase and remove non-alphabetic characters\n            var cleaned_value = field_value.toUpperCase().replace(/[^A-Z\\s]/g, '');\n            if (field_value !== cleaned_value) {\n                frm.set_value('bay', cleaned_value);\n                frappe.show_alert('Only uppercase alphabets are allowed in this field.');\n            }\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-06-12 10:08:27.950719",
  "module": "Upande Kaitet",
  "name": "Repack Button",
  "script": "// Custom Script for Material Request\n// Add this to Customization > Custom Script > Material Request\n\nfrappe.ui.form.on('Material Request', {\n    refresh: function(frm) {\n        // Show Repack button only for Material Transfer requests that are submitted\n        if (frm.doc.material_request_type === 'Material Transfer' && \n            frm.doc.docstatus === 1) {\n            \n            frm.add_custom_button(__('Repack'), function() {\n                create_repack_stock_entry(frm);\n            }, __('Create'));\n            \n            // Set button color to indicate it's a primary action\n            frm.page.btn_primary.find('.btn-group .btn:contains(\"Repack\")').addClass('btn-primary');\n        }\n    }\n});\n\nfunction create_repack_stock_entry(frm) {\n    // Validate that there are items in the request\n    if (!frm.doc.items || frm.doc.items.length === 0) {\n        frappe.msgprint(__('No items found in Material Request'));\n        return;\n    }\n    \n    // Show loading indicator\n    frappe.show_alert({\n        message: __('Creating Stock Entry...'),\n        indicator: 'blue'\n    });\n    \n    // Call server method to create Stock Entry\n    frappe.call({\n        method: 'create_repack_entry', // API Method defined in the Server Script\n        args: {\n            material_request: frm.doc.name, // Replace with the actual Material Request name\n        },\n        callback: function(response) {\n            if (response.message) {\n                frappe.show_alert({\n                    message: __('Stock Entry created successfully: {0}', [response.message]),\n                    indicator: 'green'\n                });\n    \n                // Redirect to the new Stock Entry\n                frappe.set_route('Form', 'Stock Entry', response.message);\n            }\n        },\n        error: function(error) {\n            frappe.show_alert({\n                message: __('Error creating Stock Entry'),\n                indicator: 'red'\n            });\n            console.error('Error creating Stock Entry:', error);\n        }\n    });\n\n    \n}\n\n\n\n// function create_stock_entry_doc(frm) {\n//     // Create Stock Entry document object\n//     let stock_entry = {\n//         doctype: 'Stock Entry',\n//         stock_entry_type: 'Repack',\n//         purpose: 'Repack',\n//         company: frm.doc.company,\n//         posting_date: frappe.datetime.get_today(),\n//         posting_time: frappe.datetime.now_time(),\n//         material_request: frm.doc.name,\n//         remarks: `Repack entry created from Material Request: ${frm.doc.name}`,\n//         items: []\n//     };\n    \n//     // Add items from Material Request\n//     frm.doc.items.forEach(function(item) {\n//         stock_entry.items.push({\n//             doctype: 'Stock Entry Detail',\n//             item_code: item.item_code,\n//             item_name: item.item_name,\n//             description: item.description,\n//             uom: item.uom,\n//             stock_uom: item.stock_uom || item.uom,\n//             qty: item.qty,\n//             stock_qty: item.stock_qty || item.qty,\n//             s_warehouse: item.warehouse,  // Source warehouse\n//             t_warehouse: '',  // Target warehouse - user will fill this\n//             conversion_factor: item.conversion_factor || 1,\n//             material_request: frm.doc.name,\n//             material_request_item: item.name\n//         });\n//     });\n    \n//     return stock_entry;\n// }",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Trip",
  "enabled": 0,
  "modified": "2025-05-29 11:28:46.369703",
  "module": null,
  "name": "Trip Button",
  "script": "frappe.ui.form.on('Delivery Trip', {\n    refresh: function(frm) {\n        if (frm.doc.status === \"Scheduled\" && !frm.doc.start_time) {\n            frm.add_custom_button(('Start Trip'), function () {\n                frappe.call({\n                    method: \"start_trip_transfer\",\n                    args: {\n                        delivery_trip: frm.doc.name,\n                    },\n                    callback: function() {\n                        frm.reload_doc();\n                        frappe.msgprint(\"Trip started and stock moved to Goods In Transit.\");\n                    }\n                });\n            });\n        }\n\n        if (frm.doc.status === \"In Transit\" && !frm.doc.end_time) {\n            frm.add_custom_button(('End Trip'), function () {\n                frappe.call({\n                    method: \"end_trip_transfer\",\n                    args: {\n                        delivery_trip: frm.doc.name\n                    },\n                    callback: function() {\n                        frm.reload_doc();\n                        frappe.msgprint(\"Trip completed and stock moved to Karen Yoghurt Goods.\");\n                    }\n                });\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 0,
  "modified": "2025-05-29 06:13:30.492184",
  "module": "Upande Kaitet",
  "name": "Auto-fetch Company",
  "script": "frappe.ui.form.on('Work Order', {\n    production_item: function(frm) {\n        if (!frm.doc.production_item) return;\n\n        frappe.db.get_doc('Item', frm.doc.production_item).then(item_doc => {\n            if (item_doc.default_warehouse) {\n                frappe.db.get_doc('Warehouse', item_doc.default_warehouse).then(warehouse_doc => {\n                    if (warehouse_doc.company && frm.doc.company !== warehouse_doc.company) {\n                        frm.set_value('company', warehouse_doc.company);\n                    }\n                });\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM",
  "enabled": 0,
  "modified": "2025-05-29 05:54:34.028541",
  "module": "Upande Kaitet",
  "name": "Auto-set Company on BOM based on Item's Warehouse",
  "script": "frappe.ui.form.on('Work Order', {\n    bom_no: function (frm) {\n        if (!frm.doc.bom_no) return;\n\n        frappe.call({\n            method: \"frappe.client.get\",\n            args: {\n                doctype: \"BOM\",\n                name: frm.doc.bom_no\n            },\n            callback: function (res) {\n                const bom = res.message;\n                if (bom && bom.company) {\n                    frm.set_value(\"company\", bom.company);\n                }\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 0,
  "modified": "2025-05-29 07:25:55.344400",
  "module": "Upande Kaitet",
  "name": "Auto-fetch Company from BOM in Work Order",
  "script": "frappe.ui.form.on('Work Order', {\n    bom_no: function (frm) {\n        if (!frm.doc.bom_no) return;\n\n        frappe.db.get_doc('BOM', frm.doc.bom_no).then(bom_doc => {\n            if (bom_doc.company && frm.doc.company !== bom_doc.company) {\n                frm.set_value('company', bom_doc.company);\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 0,
  "modified": "2025-05-29 07:26:02.225504",
  "module": "Upande Kaitet",
  "name": "Populate WIP and Target Warehoise in Work Order",
  "script": "frappe.ui.form.on('Work Order', {\n    // Trigger logic when BOM is manually selected\n    bom_no: function (frm) {\n        set_warehouses_based_on_bom(frm);\n    },\n\n    // Trigger logic when the form is loaded and BOM is already set\n    onload: function (frm) {\n        if (frm.doc.bom_no) {\n            set_warehouses_based_on_bom(frm);\n        }\n    }\n});\n\n// Extracted function so it's reusable\nasync function set_warehouses_based_on_bom(frm) {\n    if (!frm.doc.bom_no) return;\n\n    const { message: bom } = await frappe.db.get_value('BOM', frm.doc.bom_no, 'item');\n    if (!bom || !bom.item) return;\n\n    const item_name = bom.item.toLowerCase();\n\n    frm.set_value('wip_warehouse', 'Pasteurization Unit - KR');\n\n    if (item_name.includes('lala')) {\n        frm.set_value('fg_warehouse', 'Finished Goods - KR');\n    } else if (item_name.includes('vanilla yoghurt') || item_name.includes('strawberry yoghurt')) {\n        frm.set_value('fg_warehouse', 'Yogurt Coldroom - KR');\n    } else {\n        frm.set_value('fg_warehouse', '');\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 1,
  "modified": "2025-06-30 10:37:09.963985",
  "module": "Upande Kaitet",
  "name": "Combined Script",
  "script": "frappe.ui.form.on('Work Order', {\n    bom_no: async function (frm) {\n        if (!frm.doc.bom_no) return;\n\n        // Step 1: Fetch BOM details\n        const bom_doc = await frappe.db.get_doc('BOM', frm.doc.bom_no);\n        if (!bom_doc || !bom_doc.item) return;\n\n        const item_name = bom_doc.item.toLowerCase();\n\n        // Step 2: If BOM has a different company, set it first\n        if (bom_doc.company && frm.doc.company !== bom_doc.company) {\n            await frm.set_value('company', bom_doc.company);\n        }\n\n        // Step 3: Set WIP and Target warehouses based on item\n        frm.set_value('wip_warehouse', 'Pasteurization Unit - KR');\n\n        if (item_name.includes('maziwa lala (kg)')) {\n            frm.set_value('fg_warehouse', 'Yoghurt/Lala Packing - KR');\n        } else if (item_name.includes('yoghurt vanilla (kg)') || item_name.includes('yoghurt strawberry (kg)')) {\n            frm.set_value('fg_warehouse', 'Yoghurt/Lala Packing - KR');\n        } else {\n            frm.set_value('fg_warehouse', '');\n        }\n    },\n\n    item_to_manufacture: async function (frm) {\n        if (!frm.doc.item_to_manufacture) return;\n\n        // Fetch the item name\n        const item_name = frm.doc.item_to_manufacture.toLowerCase();\n\n        // Set Target Warehouse based on item\n        if (item_name.includes('maziwa lala (kg)')) {\n            frm.set_value('fg_warehouse', 'Yoghurt/Lala Packing - KR');\n        } else if (item_name.includes('yoghurt vanilla (kg)') || item_name.includes('yoghurt strawberry (kg)')) {\n            frm.set_value('fg_warehouse', 'Yoghurt/Lala Packing - KR');\n        } else {\n            frm.set_value('fg_warehouse', '');\n        }\n    },\n\n    onload: function (frm) {\n        if (frm.doc.bom_no) {\n            frappe.ui.form.trigger('Work Order', 'bom_no', frm);\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-05-29 12:27:07.628366",
  "module": "Upande Kaitet",
  "name": "Update Source Warehouse",
  "script": "frappe.ui.form.on('Sales Order', {\n    custom_business_unit(frm) {\n        if (frm.doc.custom_business_unit == \"Westwood Yoghurt\") {\n            frm.doc.set_warehouse = \"Yoghurt Store Karen - KR\";\n            frm.refresh_field('set_warehouse');\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-06-07 20:16:24.283675",
  "module": "Upande Kaitet",
  "name": "Fetch Farm and Business Unit",
  "script": "frappe.ui.form.on('Stock Entry', {\n    stock_entry_type: async function (frm) {\n        if (!frm.doc.stock_entry_type) return;\n\n        // Fetch selected Stock Entry Type document\n        const stock_entry_type = await frappe.db.get_doc('Stock Entry Type', frm.doc.stock_entry_type);\n\n        if (!stock_entry_type) return;\n\n        // Set custom values if available\n        if (stock_entry_type.custom_default_farm) {\n            frm.set_value('custom_farm', stock_entry_type.custom_default_farm);\n        }\n\n        if (stock_entry_type.custom_default_business_unit) {\n            frm.set_value('custom_business_unit', stock_entry_type.custom_default_business_unit);\n        }\n\n        // if (stock_entry_type.custom_default_company && frm.doc.company !== stock_entry_type.custom_default_company) {\n        //     frm.set_value('company', stock_entry_type.custom_default_company);\n        // }\n    },\n\n    // BONUS: Run on form load if Stock Entry Type is already selected\n    onload: function (frm) {\n        if (frm.doc.stock_entry_type) {\n            frappe.ui.form.trigger('Stock Entry', 'stock_entry_type', frm);\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Card",
  "enabled": 1,
  "modified": "2025-06-10 12:44:19.655971",
  "module": "Upande Kaitet",
  "name": "Start Job Script",
  "script": "frappe.ui.form.on('Job Card', {\n    onload: function (frm) {\n        enforce_quality_inspection_rule(frm);\n    },\n    refresh: function (frm) {\n        enforce_quality_inspection_rule(frm);\n    },\n    validate: function (frm) {\n        if (frm.doc.operation === \"Milk Quality Inspection\" && frm.doc.status === \"Completed\") {\n            if (!frm.doc.quality_inspection || !frm.doc.custom_quality_inspection_submitted) {\n                frappe.throw(__('You cannot complete the job without submitting a Quality Inspection for the milk.'));\n            }\n        }\n    }\n});\n\n// Helper function to enforce the quality inspection rule\nfunction enforce_quality_inspection_rule(frm) {\n    if (frm.doc.operation === \"Milk Quality Inspection\") {\n        frm.fields_dict.quality_inspection.$wrapper.find('button').off('click').on('click', function (e) {\n            if (frm.doc.status !== \"Work In Progress\") {\n                e.preventDefault();\n                frappe.msgprint(__('Please start the job before creating or selecting a Quality Inspection.'));\n            }\n        });\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-05-30 12:49:41.043144",
  "module": "Upande Kaitet",
  "name": "Default Source and Target Warehouse",
  "script": "frappe.ui.form.on('Stock Entry', {\n    stock_entry_type: function (frm) {\n        const autoTypes = [\"Milk to Yoghurt BU\", \"Milking\"];\n        const source_warehouse = \"Milk Cooler - KR\";\n        const target_warehouse = \"Pasteurization Unit - KR\";\n\n        if (autoTypes.includes(frm.doc.stock_entry_type)) {\n            (frm.doc.items || []).forEach(item => {\n                frappe.model.set_value(item.doctype, item.name, 's_warehouse', source_warehouse);\n                frappe.model.set_value(item.doctype, item.name, 't_warehouse', target_warehouse);\n            });\n        }\n    },\n\n    items_add: function (frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n        const autoTypes = [\"Milk to Yoghurt BU\", \"Milking\"];\n        const source_warehouse = \"Milk Cooler - KR\";\n        const target_warehouse = \"Pasteurization Unit - KR\";\n\n        if (autoTypes.includes(frm.doc.stock_entry_type)) {\n            frappe.model.set_value(cdt, cdn, 's_warehouse', source_warehouse);\n            frappe.model.set_value(cdt, cdn, 't_warehouse', target_warehouse);\n        }\n    },\n\n    refresh: function (frm) {\n        // Bonus enhancement: re-trigger logic when form loads\n        if (frm.doc.stock_entry_type) {\n            frappe.ui.form.trigger('Stock Entry', 'stock_entry_type');\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-05-30 08:05:27.015190",
  "module": "Upande Kaitet",
  "name": "Allow Valuation Rate",
  "script": "frappe.ui.form.on('Stock Entry', {\n\trefresh(frm) {\n\t\t// Set allow_valuation_rate for all existing items\n\t\tfrm.doc.items.forEach(function(item) {\n\t\t\tfrappe.model.set_value(item.doctype, item.name, 'allow_zero_valuation_rate', 1);\n\t\t});\n\t\tfrm.refresh_field('items');\n\t\t\n\t\t// Optional: Periodic check to ensure it stays set\n\t\tfrm.allow_valuation_interval = setInterval(() => {\n\t\t\tfrm.doc.items.forEach(function(item) {\n\t\t\t\tif (!item.allow_valuation_rate) {\n\t\t\t\t\tfrappe.model.set_value(item.doctype, item.name, 'allow_zero_valuation_rate', 1);\n\t\t\t\t}\n\t\t\t});\n\t\t}, 1000);\n\t},\n\t\n\tbefore_save(frm) {\n\t\t// Clear interval before saving\n\t\tif (frm.allow_valuation_interval) {\n\t\t\tclearInterval(frm.allow_valuation_interval);\n\t\t}\n\t}\n});\n\n// Set allow_valuation_rate when new items are added\nfrappe.ui.form.on('Stock Entry Detail', {\n\titems_add(frm, cdt, cdn) {\n\t\tfrappe.model.set_value(cdt, cdn, 'allow_zero_valuation_rate', 1);\n\t},\n\t\n\t// Set after warehouse is selected/changed\n\ts_warehouse(frm, cdt, cdn) {\n\t\tsetTimeout(() => {\n\t\t\tfrappe.model.set_value(cdt, cdn, 'allow_zero_valuation_rate', 1);\n\t\t}, 100);\n\t},\n\t\n\tt_warehouse(frm, cdt, cdn) {\n\t\tsetTimeout(() => {\n\t\t\tfrappe.model.set_value(cdt, cdn, 'allow_zero_valuation_rate', 1);\n\t\t}, 100);\n\t},\n\t\n\t// Set after item is selected/changed\n\titem_code(frm, cdt, cdn) {\n\t\tsetTimeout(() => {\n\t\t\tfrappe.model.set_value(cdt, cdn, 'allow_zero_valuation_rate', 1);\n\t\t}, 200);\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 0,
  "modified": "2025-06-03 05:19:55.677560",
  "module": "Upande Kaitet",
  "name": "Stock Entry Type Automation",
  "script": "frappe.ui.form.on('Stock Entry', {\n    onload: async function(frm) {\n        if (\n            frm.is_new() &&\n            frm.doc.material_request &&\n            (frm.doc.purpose === 'Material Issue' || frm.doc.purpose === 'Material Transfer')\n        ) {\n            try {\n                // Fetch Material Request details\n                const material_request = await frappe.db.get_doc('Material Request', frm.doc.material_request);\n\n                const is_issue = material_request.material_request_type === 'Material Issue';\n                const has_milk = material_request.items.some(item =>\n                    item.item_code.toLowerCase().includes('westwood milk')\n                );\n\n                if (is_issue && has_milk) {\n                    // Override defaults\n                    await frm.set_value('stock_entry_type', 'Milk to Yoghurt BU');\n                    await frm.set_value('purpose', 'Material Transfer');  // Correct the purpose\n                    frm.refresh_fields();\n                }\n            } catch (err) {\n                console.error('Error processing Material Request:', err);\n            }\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-06-03 05:37:26.276485",
  "module": "Upande Kaitet",
  "name": "Loss Reason Mandatory",
  "script": "frappe.ui.form.on('Stock Entry', {\n    stock_entry_type(frm) {\n        const is_loss = frm.doc.stock_entry_type === 'Yoghurt Production Losses';\n\n        // Mark fields as required (UI-only)\n        frm.fields_dict.items.grid.get_field('loss_reason').df.reqd = is_loss;\n        frm.fields_dict.items.grid.get_field('loss_description').df.reqd = is_loss;\n\n        frm.fields_dict.items.grid.refresh();\n    },\n\n    validate(frm) {\n        if (frm.doc.stock_entry_type === 'Yoghurt Production Losses') {\n            (frm.doc.items || []).forEach((row, i) => {\n                if (!row.custom_loss_reason) {\n                    frappe.throw(`Row ${i + 1}: Loss Reason is required.`);\n                }\n                if (!row.custom_loss_description) {\n                    frappe.throw(`Row ${i + 1}: Loss Description is required.`);\n                }\n            });\n        }\n    },\n\n    onload_post_render(frm) {\n        frm.trigger('stock_entry_type');\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 0,
  "modified": "2025-06-03 08:14:12.947540",
  "module": "Upande Kaitet",
  "name": "Work Order",
  "script": "frappe.ui.form.on('Work Order', {\n    refresh: function(frm) {\n        if (frm.doc.docstatus === 1 && frm.doc.status === 'In Process') {\n            frappe.call({\n                method: 'frappe.desk.form.utils.get_linked_docs_count',\n                args: {\n                    doctype: 'Work Order',\n                    name: frm.doc.name,\n                    target_doctypes: ['Job Card']\n                },\n                callback: function(r) {\n                    if (r.message['Job Card'] >= 2 && !frm.doc.custom_weighed_amount) {\n                        frm.set_df_property('custom_weighed_amount', 'reqd', 1);\n                        frm.set_df_property('custom_weighed_uom', 'reqd', 1);\n                        frappe.msgprint(__('Please enter Weighed Amount and UOM before finishing the Work Order.'));\n                    }\n                }\n            });\n        }\n    },\n\n    custom_weighed_amount: function(frm) {\n        if (frm.doc.custom_weighed_amount && !frm.doc.custom_weighed_uom) {\n            frappe.msgprint(__('Please also select the UOM for the weighed amount.'));\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "GPS Readings",
  "enabled": 1,
  "modified": "2025-06-03 07:57:13.515817",
  "module": null,
  "name": "Geo",
  "script": "// In Client Script for GPS Readings\nfrappe.ui.form.on('GPS Readings', {\n    refresh: function(frm) {\n        console.log(\"Current geolocation value:\", frm.doc.geolocation_zwck);\n        \n        // Manually test setting a location\n        frm.set_value('geolocation_zwck', '-1.2921,36.8219').then(() => {\n            console.log(\"Test location set\");\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 1,
  "modified": "2025-06-03 07:53:00.971752",
  "module": "Upande Kaitet",
  "name": "Hide Fields in Work Order",
  "script": "frappe.ui.form.on('Work Order', {\n    refresh(frm) {\n        const show_fields = frm.doc.docstatus === 1 && all_operations_completed(frm.doc.operations);\n\n        // Show or hide and set required based on conditions\n        frm.set_df_property('custom_weighed_amount', 'hidden', !show_fields);\n        frm.set_df_property('custom_weighed_amount', 'reqd', show_fields);\n\n        frm.set_df_property('custom_weighed_uom', 'hidden', !show_fields);\n        frm.set_df_property('custom_weighed_uom', 'reqd', show_fields);\n    }\n});\n\n// Helper function\nfunction all_operations_completed(operations) {\n    if (!operations || !operations.length) return false;\n    return operations.every(op => op.status === \"Completed\");\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 0,
  "modified": "2025-06-09 09:55:16.744844",
  "module": "Upande Kaitet",
  "name": "Yoghurt Manufacturing Stock Entry",
  "script": "frappe.ui.form.on('Stock Entry', {\n    onload: function(frm) {\n        // Only trigger if the stock entry was created from a Work Order\n        if (frm.doc.work_order && frm.doc.purpose === \"Material Transfer for Manufacture\") {\n            if (frm.doc.stock_entry_type !== \"Yoghurt Manufacture Stock Entry\") {\n                frm.set_value(\"stock_entry_type\", \"Yoghurt Manufacture Stock Entry\");\n            }\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Card",
  "enabled": 0,
  "modified": "2025-06-03 13:36:40.780101",
  "module": "Upande Kaitet",
  "name": "Employee Filtering",
  "script": "frappe.ui.form.on('Job Card', {\n    setup: function(frm) {\n        frm.set_query('employee', async function() {\n            const res = await frappe.call({\n                method: 'get_manufacturing_managers'\n            });\n\n            const employees = res.message || [];\n\n            return {\n                filters: [\n                    ['Employee', 'name', 'in', employees]\n                ]\n            };\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quality Inspection",
  "enabled": 0,
  "modified": "2025-06-04 12:57:08.208859",
  "module": "Upande Kaitet",
  "name": "Request Concession Button",
  "script": "frappe.ui.form.on('Quality Inspection', {\n    refresh: function(frm) {\n        // Add the 'Request Concession' button if the status is 'Rejected'\n        if (frm.doc.docstatus === 1 && frm.doc.status === 'Rejected' && !frm.doc.concession_requested) {\n            frm.add_custom_button(__('Request Concession'), function() {\n                frappe.confirm(\n                    __('Are you sure you want to request a concession?'),\n                    function() {\n                        // Call frappe's built-in set_value function via server\n                        frappe.call({\n                            method: 'frappe.client.set_value',\n                            args: {\n                                doctype: 'Quality Inspection',\n                                name: frm.doc.name,\n                                fieldname: {\n                                    status: 'Accepted',\n                                    concession_requested: 1\n                                }\n                            },\n                            callback: function(response) {\n                                if (!response.exc) {\n                                    frappe.msgprint(__('Concession has been requested, and the status is updated to Accepted.'));\n                                    frm.reload_doc();\n                                } else {\n                                    frappe.msgprint(__('There was an error while requesting the concession.'));\n                                }\n                            }\n                        });\n                    }\n                );\n            }).addClass('btn-primary');\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quality Inspection",
  "enabled": 0,
  "modified": "2025-06-03 14:22:43.644735",
  "module": "Upande Kaitet",
  "name": "Request Concession 2",
  "script": "frappe.ui.form.on('Quality Inspection', {\n    refresh: function(frm) {\n        if (frm.doc.docstatus === 1 && frm.doc.status === 'Rejected' && !frm.doc.concession_requested) {\n            frm.add_custom_button(__('Request Concession'), function() {\n                frappe.confirm(\n                    __('Are you sure you want to request a concession?'),\n                    function() {\n                        // Call the server-side method\n                        frappe.call({\n                            method: 'request_concession',\n                            args: {\n                                quality_inspection_name: frm.doc.name\n                            },\n                            callback: function(r) {\n                                if (r.message && r.message.success) {\n                                    frappe.msgprint(r.message.message);\n                                    frm.reload_doc();\n                                } else if (r.message && !r.message.success) {\n                                    frappe.msgprint(r.message.message);\n                                }\n                            }\n                        });\n                    }\n                );\n            }).addClass('btn-primary');\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 0,
  "modified": "2025-06-08 08:22:20.782441",
  "module": null,
  "name": "Amount Calc Based on IGP",
  "script": "frappe.ui.form.on('Sales Order Item', {\n    custom_length(frm, cdt, cdn) {\n        let row = frappe.get_doc(cdt, cdn);\n        // if (row.item_group && row.custom_length) {\n        //     frappe.call({\n        //         method: 'get_item_group_price',\n        //         args: {\n        //             item_group: row.item_group,\n        //             length: row.custom_length,\n        //             currency: frm.doc.currency\n        //         },\n        //         callback: function(r) {\n                    \n        frappe.model.set_value(cdt, cdn, 'rate', 0);\n        frappe.model.set_value(cdt, cdn, 'stock_uom_rate', 0);\n        frappe.model.set_value(cdt, cdn, 'amount', 0);\n        frappe.msgprint(`No price found for this customer's currency or the selected item. Please set a price to proceed!`);\n    \n        //         }\n        //     });\n        // }\n    },\n    \n    item_code(frm, cdt, cdn) {\n        let row = frappe.get_doc(cdt, cdn);\n\n        setTimeout(function() {\n            frappe.model.set_value(cdt, cdn, 'rate', 0);\n            frappe.model.set_value(cdt, cdn, 'stock_uom_rate', 0);\n            frappe.model.set_value(cdt, cdn, 'amount', 0);\n            frappe.msgprint(`No price found for this customer's currency or the selected item. Please set a price to proceed!`);\n            \n            // Also make amount field editable\n            cur_frm.fields_dict.items.grid.toggle_enable(\"amount\", true);\n        }, 300);\n    }\n    \n});\n\nfrappe.ui.form.on(\"Sales Order\", {\n    refresh: function(frm) {\n        frm.fields_dict.items.grid.toggle_enable(\"amount\", true);\n    },\n    \n    onload: function(frm) {\n        // Ensure price list doesn't affect anything\n        frm.set_value('ignore_pricing_rule', 1);\n        \n        // Make amount field editable\n        frm.fields_dict.items.grid.toggle_enable(\"amount\", true);\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-06-17 06:20:46.051072",
  "module": "Upande Kaitet",
  "name": "SO target warehouse Population",
  "script": "frappe.ui.form.on('Sales Order Item', {\n    \n    custom_source_warehouse: async function(frm, cdt, cdn) {\n        if (frm.doc.custom_sales_order_type == \"Roses\") {\n            let row = locals[cdt][cdn];\n            if (!row.custom_source_warehouse) return;\n            \n            let source_warehouse = row.custom_source_warehouse;\n            let target_warehouse = null;\n            \n            // Get the map doc to get the target warehuse for this source warehouse\n            const map_doc = await frappe.db.get_doc(\"SO Warehouse Mapping\", \"Roses-MAP\");\n            const map_array = map_doc.items;\n            \n            const map_object = map_array.find(item => item.source_warehouse == source_warehouse);\n            target_warehouse = map_object.delivery_warehouse;\n            \n            row.warehouse = target_warehouse;\n        }\n        \n    }\n});\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Grader QR Code",
  "enabled": 1,
  "modified": "2025-04-08 16:08:22.033556",
  "module": "Upande Kaitet",
  "name": "Set List View Limit to 500(GRADER)",
  "script": "frappe.listview_settings[\"Grader QR Code\"] = {\n    refresh:  function(listview) {\n        listview.page_length =1000;\n        listview.start = 0;\n        listview.refresh();\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-03-28 12:28:32.692244",
  "module": "Upande Kaitet",
  "name": "Ensure Uppercase in Bay Field",
  "script": "frappe.ui.form.on('Stock Entry Detail', {\n\tcustom_bay(frm, cdt, cdn) {\n\t\tlet row = locals[cdt][cdn]; \n        let value = row.custom_bay || '';\n        frappe.model.set_value(cdt, cdn, 'custom_bay', value.toUpperCase());\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Label Print",
  "enabled": 1,
  "modified": "2025-04-09 16:01:21.217385",
  "module": "Upande Kaitet",
  "name": "Generate Bucket Codes",
  "script": "frappe.ui.form.on('Label Print', {\n\tafter_save(frm) {\n\t    let variety;\n\t    let number_of_labels;\n\t    let doc_name;\n\t    let action;\n\t    let farm;\n\t    let stem_length;\n\t    let bunch_size, grader, day_code;\n\t    \n\t    let args = {\n\t        action : frm.doc.action,\n\t        label_doc_name: frm.doc.name,\n\t        \n\t    };\n\t    \n\t    if (frm.doc.action === 'Harvesting Label') {\n\t        args.variety = frm.doc.item_code;\n    \t\targs.no_of_labels = frm.doc.number_of_labels;\n\n\t    } else if (frm.doc.action === 'Bunch Label') {\n\t        args.variety = frm.doc.variety;\n\t        args.no_of_labels = frm.doc.no_of_labels;\n\t        args.farm = frm.doc.farm;\n\t        args.stem_length = frm.doc.stem_length;\n\t        args.bunch_size = frm.doc.bunch_size;\n\t        args.farm_code = frm.doc.farm_code;\n\t        \n\t    } else if (frm.doc.action === 'Grader Label') {\n\t        args.grader = frm.doc.grader;\n\t        args.no_of_labels = frm.doc.qty_of_labels;\n\t        args.day_code = frm.doc.day_code;\n\t    }\n\t    \n\t    \n\t\t\n\t\tlet bucket_id;\n\t\t\n\t\tfrappe.call({\n\t\t    method: \"upande_kaitet.server_scripts.gen_label_id.generate_id\",\n\t\t    args: args,\n\t\t    callback:(response) => {\n\t\t        console.log(response);\n\t\t    }\n\t\t});\n\t\t\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Harvest",
  "enabled": 1,
  "modified": "2025-07-02 11:45:10.996380",
  "module": "Upande Kaitet",
  "name": "Harvest Scan",
  "script": "frappe.ui.form.on('Harvest', {\n    refresh(frm) {\n        frm.add_custom_button(\"Scan QR Code\", () => {\n            checkAndStartScanner();\n        });\n\n        function checkAndStartScanner() {\n            const { farm, block } = frm.doc;\n\n            if (!farm || !block) {\n                return;\n            }\n            \n            if (!window.Html5Qrcode) {\n                const script = document.createElement(\"script\");\n                script.src = \"https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js\";\n                script.onload = () => {\n                    console.log(\"Html5Qrcode library loaded successfully.\");\n                    showQrScannerDialog();\n                };\n                script.onerror = () => {\n                    console.error(\"Failed to load Html5Qrcode library.\");\n                    frappe.msgprint(\"Failed to load QR scanning library. Please check your network connection.\");\n                };\n                document.head.appendChild(script);\n            } else {\n                showQrScannerDialog();\n            }\n        }\n\n        function showQrScannerDialog() {\n            const dialog = new frappe.ui.Dialog({\n                title: \"Scan QR Code\",\n                fields: [\n                    { fieldname: 'qr_scanner', fieldtype: 'HTML', options: '' }\n                ]\n            });\n\n            const $wrapper = dialog.fields_dict.qr_scanner.$wrapper;\n            $wrapper.html('<div id=\"qr-reader\" style=\"width: 100%;\"></div>');\n\n            dialog.show();\n\n            setTimeout(() => {\n                const qrReaderElement = document.getElementById(\"qr-reader\");\n                if (qrReaderElement) {\n                    initializeQrScanner(qrReaderElement, dialog);\n                } else {\n                    console.error(\"QR Reader element not found!\");\n                    frappe.msgprint(\"Error initializing QR scanner. Please try again.\");\n                }\n            }, 300);\n        }\n\n        let isProcessing = false;\n\n        function initializeQrScanner(qrReaderElement, dialog) {\n            const html5QrCode = new Html5Qrcode(\"qr-reader\");\n\n            html5QrCode.start(\n                { facingMode: \"environment\" },\n                {\n                    fps: 15,\n                    qrbox: { width: 250, height: 250 }\n                },\n                async (decodedText, decodedResult) => {\n                    if (isProcessing) return;\n                    isProcessing = true;\n\n                    try {\n                        \n                        const parsed = JSON.parse(decodedText);\n                        const keys_array = Object.keys(parsed);\n                        const bucket_id = keys_array.find(key => parsed[key] === \"bucket\");\n                        \n                        \n                        // Check if the bucket id is in use\n                        const exists = await frappe.db.exists(\"Bucket QR Code\", bucket_id);\n\n                        let bkt_id_doc;\n                    \n                        if (exists) {\n                            bkt_id_doc = await frappe.db.get_doc(\"Bucket QR Code\", bucket_id);\n                    \n                            if (bkt_id_doc.status === \"In Use\") {\n                                frappe.msgprint(`Bucket ID ${bucket_id} is already In Use.`);\n                                setTimeout(() => {\n                                    frappe.set_route('Form', frm.doctype, 'new');\n                                }, 2000);\n                    \n                                setTimeout(() => {\n                                    window.location.reload();\n                                }, 1000);\n                                return;\n                            }\n                        } else {\n                            // Create new Bucket QR Code doc with ID = bucket_id\n                            await frappe.call({\n                                method: \"frappe.client.insert\",\n                                args: {\n                                    doc: {\n                                        doctype: \"Bucket QR Code\",\n                                        id: bucket_id,\n                                        status: \"Available\"  // or your default status\n                                    }\n                                },\n                                callback: function (r) {\n                                    if (!r.exc) {\n                                        console.log(`Created new Bucket QR Code: ${bucket_id}`);\n                                    }\n                                }\n                            });\n                        }\n\n                        \n                            \n                        frm.set_value('bucket_id', bucket_id);\n                        frm.refresh_fields(['item_code', 'bucket_id']);\n                        html5QrCode.stop();\n                        dialog.hide();\n                        \n\n                    } catch (e) {\n                        frappe.msgprint(\"Scanned a Non-Harvesting Label. Please scan a valid Bucket label.\")\n                        setTimeout(() => {\n                            frappe.set_route('Form', frm.doctype, 'new');\n                        }, 2000);\n                        \n                        setTimeout(() => {\n                            window.location.reload();\n                        }, 1000);\n                        console.error(\"Error parsing QR Code:\", error)\n                    }\n\n                    html5QrCode.stop();\n                    dialog.hide();\n                },\n                (errorMessage) => {\n                    console.warn(\"Scanning error:\", errorMessage);\n                }\n            ).catch((err) => {\n                console.error(\"Error starting QR scanner:\", err);\n                frappe.msgprint(\"Unable to access the camera. Please ensure permissions are granted and try again.\");\n            });\n\n            dialog.on(\"hide\", function () {\n                html5QrCode.stop().then(() => {\n                    console.log(\"QR Scanner stopped.\");\n                }).catch((err) => {\n                    console.error(\"Error stopping QR scanner:\", err);\n                });\n            });\n        }\n\n        // Automatically start scanning when farm and block are filled\n        frm.fields_dict.farm.df.onchange = checkAndStartScanner;\n        frm.fields_dict.block.df.onchange = checkAndStartScanner;\n\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-02-22 13:17:55.103138",
  "module": "Upande Kaitet",
  "name": "Archive Employee",
  "script": "frappe.ui.form.on('Stock Entry', {\n    onload: function (frm) {\n        frm.fields_dict['custom_graded_by'].get_query = function() {\n            return {\n                filters: {\n                    'custom_archived': 0\n                }\n            };\n        };\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Scan",
  "enabled": 0,
  "modified": "2025-03-11 12:55:52.851477",
  "module": "Upande Kaitet",
  "name": "Scan QR Button",
  "script": "frappe.ui.form.on('Scan', {\n    refresh(frm) {\n        frm.add_custom_button(\"Scan QR Code\", () => {\n            \n            const farm = cur_frm.doc.farm;\n            const action = cur_frm.doc.action;\n                        \n            if (!farm || !action) {\n                frappe.throw(\"Please select a farm and action before scanning.\");\n                return;\n            }\n            \n            if (!window.Html5Qrcode) {\n                const script = document.createElement(\"script\");\n                script.src = \"https://unpkg.com/html5-qrcode\";\n                script.onload = () => {\n                    console.log(\"Html5Qrcode library loaded successfully.\");\n                    showQrScannerDialog();\n                };\n                script.onerror = () => {\n                    console.error(\"Failed to load Html5Qrcode library.\");\n                    frappe.msgprint(\"Failed to load QR scanning library. Please check your network connection.\");\n                };\n                document.head.appendChild(script);\n            } else {\n                showQrScannerDialog();\n            }\n            \n            \n            \n            function showQrScannerDialog() {\n                const dialog = new frappe.ui.Dialog({\n                    title: \"Scan QR Code\",\n                    fields: [\n                        { fieldname: 'qr_scanner', fieldtype: 'HTML', options: '' }\n                    ]\n                });\n\n                const $wrapper = dialog.fields_dict.qr_scanner.$wrapper;\n                $wrapper.html('<div id=\"qr-reader\" style=\"width: 100%;\"></div>');\n\n                dialog.show();\n\n                setTimeout(() => {\n                    const qrReaderElement = document.getElementById(\"qr-reader\");\n                    if (qrReaderElement) {\n                        initializeQrScanner(qrReaderElement, dialog);\n                    } else {\n                        console.error(\"QR Reader element not found!\");\n                        frappe.msgprint(\"Error initializing QR scanner. Please try again.\");\n                    }\n                }, 300);\n            }\n            \n            let isProcessing = false;\n            let createStock = false;\n            let boxLabelData  = null;\n            let isPaused = false;\n            let farmPackListDocId = null;\n            let boxStickerDocId = null;\n            let stockEntryDoc;\n            \n            function initializeQrScanner(qrReaderElement, dialog) {\n                const html5QrCode = new Html5Qrcode(\"qr-reader\");\n\n                html5QrCode.start(\n                    { facingMode: \"environment\" }, \n                    {\n                        fps: 15, \n                        qrbox: { width: 250, height: 250 } \n                    },\n                    async (decodedText, decodedResult) => {\n                        if (isProcessing || isPaused) {\n                            return;\n                        }\n                        isProcessing = true;\n                        \n                        \n                        \n                    },\n                    (errorMessage) => {\n                        console.warn(\"Scanning error:\", errorMessage);\n                    }\n                ).catch((err) => {\n                    console.error(\"Error starting QR scanner:\", err);\n                    frappe.msgprint(\"Unable to access the camera. Please ensure permissions are granted and try again.\");\n                });\n\n                dialog.on(\"hide\", function () {\n                    html5QrCode.stop().then(() => {\n                        console.log(\"QR Scanner stopped.\");\n                    }).catch((err) => {\n                        console.error(\"Error stopping QR scanner:\", err);\n                    });\n                });\n            }\n            \n            function getStockEntryIdFromUrl(stockEntryUrl) {\n                const stock_entry_url_arr = stockEntryUrl.split(\"/\");\n                const arrLength = stock_entry_url_arr.length;\n                const stock_entry_id = stock_entry_url_arr[arrLength - 1];\n                \n                return stock_entry_id;\n            }\n            \n            \n            \n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-01-25 20:29:13.185615",
  "module": "Upande Kaitet",
  "name": "Populate Number of Items",
  "script": "frappe.ui.form.on('Stock Entry', {\n    refresh: function(frm){\n        $.each(frm.doc.items, function(i, row){\n            if (row.uom == 'Stems') {\n                row.custom_number_of_stems = row.qty;\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-02-22 14:41:27.648541",
  "module": "Upande Kaitet",
  "name": "Grading Stock Entry",
  "script": "frappe.ui.form.on('Stock Entry', {\n    custom_farm: function(frm) {\n        if (frm.doc.stock_entry_type === \"Grading\") {\n            let warehouseMapping = {\n                \"Burguret\": { source: \"Burguret Receiving Cold Store - TL\", target: \"Burguret Graded General - TL\" },\n                \"Turaco\": { source: \"Turaco Receiving Cold Store - TL\", target: \"Turaco Graded General - TL\" },\n                \"Pendekeza\": { source: \"Pendekeza Receiving Cold Store - TL\", target: \"Pendekeza Graded General - TL\" }\n            };\n\n            let selectedFarm = frm.doc.custom_farm;\n\n            if (selectedFarm && warehouseMapping[selectedFarm]) {\n                frm.set_value(\"from_warehouse\", warehouseMapping[selectedFarm].source);\n                frm.set_value(\"to_warehouse\", warehouseMapping[selectedFarm].target);\n            }\n        }\n    },\n    \n    custom_bunched_by: function(frm) {\n        if (frm.doc.stock_entry_type === \"Grading\") {\n            if (frm.doc.custom_bunched_by) {\n                let bunched_by_value = frm.doc.custom_bunched_by;\n\n                if (frm.doc.items && frm.doc.items.length > 0) {\n                    frm.doc.items.forEach((item, idx) => {\n                        frappe.model.set_value(item.doctype, item.name, 'uom', bunched_by_value); \n                    });\n                \n                } else {\n                    frappe.throw(\"No items found in the child table.\");\n                }\n\n            }\n        }\n    },\n\n    stock_entry_type: function(frm) {\n        if (frm.doc.stock_entry_type === \"Grading\") {\n            frm.trigger(\"custom_farm\");\n            frm.trigger(\"custom_bunched_by\");\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-03-31 20:44:08.467268",
  "module": "Upande Kaitet",
  "name": "Field Rejects Stock Entry",
  "script": "// frappe.ui.form.on('Stock Entry', {\n//     custom_greenhouse: function(frm) {\n//         if (frm.doc.stock_entry_type === \"Field Rejects\") {\n//             const greenhouse = frm.doc.custom_greenhouse;\n            \n//             let warehouseMapping = {\n//                 \"Burguret\":{ target: `${greenhouse}` },\n//                 \"Turaco\":{ target: `${greenhouse}`},\n//                 \"Pendekeza\": { target: `${greenhouse}` }\n//             };\n            \n//             let selectedFarm = frm.doc.custom_farm;\n\n//             if (selectedFarm && warehouseMapping[selectedFarm]) {\n//                 // frm.set_value(\"from_warehouse\", warehouseMapping[selectedFarm].source);\n//                 frm.set_value(\"to_warehouse\", warehouseMapping[selectedFarm].target);\n//             }\n//         }\n//     },\n\n//     stock_entry_type: function(frm) {\n//         if (frm.doc.stock_entry_type === \"Field Rejects\") {\n//             frm.trigger(\"custom_greenhouse\");\n//         }\n//     }\n// });\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-03-11 16:53:28.012126",
  "module": "Upande Kaitet",
  "name": "Qr Code gen",
  "script": "frappe.ui.form.on('Stock Entry', {\n    before_submit: function(frm) {\n        if (frm.doc.docstatus === 0 && ( frm.doc.stock_entry_type === 'Grading' || frm.doc.stock_entry_type === 'Grading without Receiving') ) {\n            \n            const grading_details = {\n                \"name\": frm.doc.name,\n                \"variety\": frm.doc.items[0].item_code,\n                \"grader\": frm.doc.custom_graded_by,\n                \"qty\": frm.doc.items[0].qty,\n            };\n            \n            const response = frappe.call({\n                method: \"upande_kaitet.server_scripts.qr_code_generator.generate_qr_code\",\n                args: {\n                    stock_entry_details: JSON.stringify(grading_details)\n                },\n            });\n            \n           \n            \n        }\n    },\n\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Scan",
  "enabled": 1,
  "modified": "2025-02-16 13:38:22.614916",
  "module": "Upande Kaitet",
  "name": "Scan Data Field Listener",
  "script": "frappe.ui.form.on('Scan', {\n    refresh(frm) {\n        if (!frm.fields_dict.scan_data.$wrapper.hasClass('scan-data-bound')) {\n            frm.fields_dict.scan_data.$wrapper.on('change', function () {\n                frm.script_manager.trigger('scan_data');\n            });\n\n            frm.fields_dict.scan_data.$wrapper.addClass('scan-data-bound');\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Scan",
  "enabled": 1,
  "modified": "2025-06-23 19:24:48.024971",
  "module": "Upande Kaitet",
  "name": "Scan Via Honeywell",
  "script": "frappe.ui.form.on('Scan', {\n\trefresh(frm) {\n\t    toggle_scan_data_field(frm);\n\t},\n\t\n\tfarm(frm) {\n\t    toggle_scan_data_field(frm);\n\t},\n\t\n\taction(frm) {\n\t    toggle_scan_data_field(frm);\n\t},\n\t\n\t\n\t\n\tasync scan_data(frm) {\n\t    let audio = new Audio('/assets/upande_kaitet/sounds/store-scanner-beep-90395.mp3');\n\n\t    let scan_value = frm.doc.scan_data;\n\t    let farm = frm.doc.farm;\n        let action = frm.doc.action;\n        let boxStickerDocId = frm.doc.box_sticker || null;\n\n\n\t    if (scan_value && !frm.is_processing_stock_entry) {\n\t        frm.is_processing_stock_entry = true;\n\t        frm.set_df_property('scan_data', 'read_only', 1);\n\n\t        if (action === 'Packing') {\n\t            if (!frm.doc.opl_data) {\n\t               // Check if scan_value is the opl url\n\t               if (scan_value.includes('order-pick-list')) {\n\t                   \n\t                    frm.set_value('opl_data', scan_value);\n    \t                const oplId = scan_value.split('/').pop();\n    \t                \n                        const oplDoc = await frappe.db.get_doc(\"Order Pick List\", oplId);\n\t                   \n\t                   if (oplDoc.docstatus == 2) {\n    \t                    frappe.throw(\"This Order Pick List is cancelled. Request the updated Order Pick List\")\n    \t                }\n    \t                \n    \t                frm.set_value('order_pick_list', oplId);\n                        audio.play();\n    \t                frappe.msgprint('Order Pick List scanned. Now scan bunch labels.');\n\t               } else {\n\t                    frm.set_df_property('scan_data', 'read_only', 0);\n\t                    frm.set_value('scan_data', '');\n\t                    frappe.throw(\"Please Scan a valid Order Pick List\");\n\t               }\n\t                \n\t                \n\t                frm.set_df_property('scan_data', 'read_only', 0);\n\t                frm.set_value('scan_data', '');\n\n\n\t                frm.is_processing_stock_entry = false;\n\t                \n\t                setTimeout(() => {\n                        frm.save();\n                    }, 50);\n\n                    \n\t            } else {\n\n\t                let bunchLabelData = scan_value;\n\t                try {\n                        await process_bunch_scan(frm.doc.opl_data, bunchLabelData, farm, action, frm, audio);\n                        // frappe.msgprint('Bunch scanned. Scan next bunch or Close Box');\n                        frm.set_df_property('scan_data', 'read_only', 0);\n                        frm.set_value('scan_data', '');\n                    } catch (error) {\n                        if (error.message.toLowerCase.includes(\"this bunch has not been graded on the system\")) {\n                            console.log(error.message);\n                        } else {\n                            frappe.msgprint(`Error processing bunch scan: ${error.message}`);\n                        }\n                        \n                    }\n\t                \n                    frm.set_df_property('scan_data', 'read_only', 0);\n\t                frm.set_value('scan_data', '');\n\t                frm.is_processing_stock_entry = false;\n\t            }\n\t           \n\t            \n\t        } else if (action === 'Grading') {\n\t            // Start with fetching the grader's name.\n\t            //If it is not a grader label and it's the first scan(grader field is not populated), throw error telling user to scan grader label first.\n\t            const data = JSON.parse(scan_value);\n\t            const bunchLabelData = data;\n\t            \n\t            if (!frm.doc.grader) {\n\t               if (!data.grader ) {\n    \t               frappe.throw(\"Please scan the Grader label first!\");\n    \t           }\n    \t           \n    \t            //Store the grader in the grader field\n\t                frm.set_value('grader', data.grader);\n\t                audio.play();\n\t                frappe.msgprint('Grader Label scanned. Now scan bunch labels.');\n                    frm.set_df_property('scan_data', 'read_only', 0);\n                    frm.set_value('scan_data', '');\n    \n    \n                    frm.is_processing_stock_entry = false;\n                    \n                    setTimeout(() => {\n                        frm.save();\n                    }, 250);\n                    \n    \t           \n\t            } else {\n\t                \n\t                \n                    try {\n                        await process_grading_bunch_scan(bunchLabelData, farm, action, frm, audio);\n                        frappe.msgprint(`Bunch scanned successfully. Scan next bunch belonging to ${frm.doc.graders_name}!`);\n                        frm.set_df_property('scan_data', 'read_only', 0);\n                        frm.set_value('scan_data', '');\n                    } catch (error) {\n                        \n                        if (error.message.includes('Bunch has already been scanned.')) {\n                            console.log('Bunch already scanned');\n                        } else {\n                            frappe.msgprint(`Error processing bunch scan: ${error.message}`);\n                        }\n                        \n                        \n                        \n                    }\n\t                \n                    frm.set_df_property('scan_data', 'read_only', 0);\n\t                frm.set_value('scan_data', '');\n\t                frm.is_processing_stock_entry = false;\n\t                \n\t                setTimeout(() => {\n                        frm.save();\n                    }, 250);\n\t            }\n\t           \n\t           \n\t            \n\t        } else if (action === 'Receiving') {\n                trigger_stock_entry(scan_value, farm, action, audio).finally(() => {\n                    frm.set_df_property('scan_data', 'read_only', 0);\n                    frm.set_value('scan_data', '');\n                    frm.is_processing_stock_entry = false;\n                    setTimeout(() => {\n                        frm.save();\n                    }, 250);\n                });\n            } else if (action === 'Receiving Quarantined') {\n                await trigger_stock_entry(scan_value, farm, action).finally(() => {\n                    frm.set_df_property('scan_data', 'read_only', 0);\n                    frm.set_value('scan_data', '');\n                    frm.is_processing_stock_entry = false;\n                });\n                \n            } else if (action === 'Grading Check') {\n                // let stockEntryName;\n                // let scan_check_doc;\n\n                // if (!frm.doc.checking_label) {\n                //     scan_check_doc = frappe.model.get_new_doc('Scan Check');\n                    \n                //     frm.doc.scan_check_id = scan_check_doc.name;\n                    \n                //     frappe.msgprint(`Created Scan Check: ${scan_check_doc.name}`);\n                    \n                //     frm.doc.checking_label = 1;\n                //     await frm.save();\n                    \n                // }\n                \n                // scan_check_doc = await frappe.db.get_doc('Scan Check', frm.doc.scan_check_id)\n                \n                let variety, qty, grower, uom, harvester, greenhouse, block__bed_number, stockEntryDoc, items,\n                    stem_length, graded_by, bunched_by;\n                    \n                if ( scan_value.includes(\"farm\") && scan_value.includes(\"variety\") ) {\n                    \n                    const bunchData = JSON.parse(scan_value);\n    \n                    const existingEntries = await frappe.db.get_list('Stock Entry', {\n                        fields: ['name', 'custom_bunch_id'],\n                        filters: {\n                            custom_bunch_id: bunchData.bunch_id\n                        },\n                        limit: 1\n                    });\n                    \n                    if (existingEntries.length === 0) {\n                        frappe.msgprint(\"Bunch Status: NOT GRADED\");\n                    } else {\n                        audio.play();\n                        frappe.msgprint(\"Bunch Status: GRADED\");\n                    }\n                    \n                // This is harvesting qr code data\n                } else if (scan_value.startsWith('BUCKET')) {\n                    \n                    // frappe.msgprint(`Harvester: ${harvester}, Greenhouse: ${greenhouse}, Bay: ${block__bed_number}, Variety: ${variety}, No. of Stems: ${qty} `);\n                }\n                \n                \n            \n                frm.set_df_property('scan_data', 'read_only', 0);\n                frm.set_value('scan_data', '');\n                frm.is_processing_stock_entry = false;\n                \n                \n                \n                setTimeout(() => {\n                    frm.save();\n                }, 1000);\n                \n            } \n\t    }\n\t}\n\t\n});\n\nasync function process_grading_bunch_scan(bunchLabelData, farm, action, frm, audio) {\n    \n    try {\n        // Get the stock entry with the bunch Id\n        // Check if bunch is scanned via the custom_scanned_grading field\n        const existingEntry = await frappe.db.get_list('Stock Entry', {\n            fields: ['name', 'custom_scanned_grading'],\n            filters: {\n                custom_bunch_id: bunchLabelData.bunch_id\n            },\n            limit: 1\n        });\n        \n       \n        // Check if bunch is already scanned\n        if (existingEntry.length > 0 && existingEntry[0].custom_scanned_grading === 1) {\n            frappe.throw('Bunch has already been scanned.');\n            return;\n        }\n        \n        // Create a new stock entry\n        const stockEntry = frappe.model.get_new_doc('Stock Entry');\n\n        stockEntry.stock_entry_type = 'Grading';\n        \n        // Get the mapping for the farm\n        const farm_mapping_doc = await frappe.db.get_doc(\"Scan Location Mapping\", `${farm}-MAP`);\n        const mapping_items = farm_mapping_doc.items;\n        \n        const row_array = mapping_items.filter(item => item.action == action)\n        \n        stockEntry.from_warehouse = row_array[0].source_warehouse;\n        stockEntry.to_warehouse = row_array[0].target_warehouse;\n        \n        const farm_doc = await frappe.db.get_doc(\"Farm\", farm);\n        const company = farm_doc.company;\n        \n        stockEntry.custom_farm = farm;\n        stockEntry.company = company;\n        stockEntry.custom_business_unit = \"Roses\";\n        \n        stockEntry.custom_graded_by = frm.doc.grader;\n        stockEntry.custom_stem_length = bunchLabelData.stem_length;\n        stockEntry.custom_bunched_by = bunchLabelData.bunch_size;\n        stockEntry.custom_bunch_id = bunchLabelData.bunch_id;\n        stockEntry.custom_scanned_grading = 1;\n\n        stockEntry.items = [{\n            item_code: bunchLabelData.variety,\n            uom: bunchLabelData.bunch_size,\n            qty: 1\n        }];\n\n        await frappe.db.insert(stockEntry);\n        audio.play();\n        frappe.msgprint('Stock transfered successfully.');\n    } catch (error) {\n\n        frappe.throw(__('Error creating Stock Entry: ') + error.message);\n        \n        \n    }\n    \n}\n\nlet farmPackListDocId = null;\n\n\n\nfunction getNameFromUrl(url) {\n    const urlArray = url.split(\"/\");\n    const arrayLength = urlArray.length;\n    const name = urlArray[arrayLength - 1];\n    \n    return name;\n}\n\n\n\nasync function trigger_stock_entry(scan_value, farm, action, audio) {\n    await createStockEntry(scan_value, farm, action, audio);\n    \n    if (action === 'Receiving') {\n        frappe.msgprint(`Received Bucket and Created Stock Entry successfully`);\n        frappe.msgprint(``)\n    } else if (action === 'Receiving Quarantined') {\n        frappe.msgprint(`Received and moved Bucket to quarantine`);\n    }\n    \n}\n\n\n\nasync function process_bunch_scan(opl_url, bunchLabelData, farm, action, frm, audio) {\n        \n    const oplName = getNameFromUrl(opl_url);\n    \n    const bunchData = JSON.parse(bunchLabelData)\n    \n    const existingEntries = await frappe.db.get_list('Stock Entry', {\n        fields: ['name', 'custom_bunch_id'],\n        filters: {\n            custom_bunch_id: bunchData.bunch_id\n        },\n        limit: 1\n    });\n    \n    \n\n    // If no matching stock entry is found\n    if (existingEntries.length === 0) {\n        frappe.throw(`This bunch has not been graded in the system. Perform the grading scan on it to enable packing: ${bunchData.bunch_id}`);\n    }\n    const bunchStockEntryName = existingEntries[0].name;\n    const stockEntryUrl = `/app/stock-entry/${bunchStockEntryName}`;\n    let bunchName;\n    let previouslyScannedItems;\n    let previously_scanned_items_list\n    \n    let totalBunches = 0;\n    let scannedBunches = 0;\n    \n    let stockEntryDoc;\n    \n    \n    try {\n        stockEntryDoc = await frappe.db.get_doc('Stock Entry', bunchStockEntryName);\n    } catch (error) {\n        frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n    }\n    \n    if (stockEntryDoc.custom_scanned_packing ) {\n        frappe.msgprint(\"Bunch aready scanned!\");\n        return;\n    }\n    \n    // frappe.call({\n    //     method: \"upande_kaitet.server_scripts.update_custom_scanned.update_custom_scanned\",\n    //     args: { stock_entry_name: stockEntryName }\n    // });\n    \n    // returns an object with total items and scanned items\n    let varietyMatch = {};\n    \n    \n    try {\n        varietyMatch = await validateLabels(oplName, bunchLabelData, previouslyScannedItems, frm);\n        bunchName = bunchData.variety;\n        \n        if (!varietyMatch.valid) {\n            frappe.throw(`${bunchName} does not match the Order Pick List!`);\n        }\n    } catch (error) {\n        frappe.throw(`Error validating labels: ${error}`);\n        return;\n    }\n    \n    const box_id = varietyMatch.box_number;\n    const box_label = varietyMatch.box_label;\n\n    // Add bunch detail to scanned_items child table\n    const newBunchDetails = {\n        variety: bunchData.variety,\n        bunch_size: bunchData.bunch_size,\n        number_of_bunches: 1,\n    };\n    \n\n    totalBunches = frm.doc.total_bunches;\n    totalScanned = varietyMatch.scannedItems + 1;\n    \n    frm.set_value('scanned_bunches', totalScanned);\n    frappe.msgprint(`${totalScanned} of ${totalBunches} scanned`)\n    \n\n    await createOrGetFarmPackList(oplName, bunchStockEntryName, box_id, box_label, totalBunches);\n    \n    // Mark the bunch as scanned\n    frappe.call({\n        method: \"upande_kaitet.server_scripts.update_custom_scanned.update_custom_scanned\",\n        args: { \n            stock_entry_name: bunchStockEntryName,\n            action: action,\n            oplName: oplName,\n        }\n    });\n    \n    audio.play();\n    frm.save();\n    \n}\n\n\nasync function createOrGetFarmPackList(oplName, bunchStockEntryName, box_id, box_label, totalBunches) {\n\n    const { sales_order, farm } = await getSalesOrderAndFarmFromOPL(oplName);\n    \n    if (!sales_order || farm == \"Unknown\" ) {\n        frappe.throw(\"Sales Order or Warehouse details missing in Order Pick List.\");\n        return;\n    }\n    \n    const existingFPL = await frappe.db.get_list(\"Farm Pack List\", {\n        filters: {\n            custom_sales_order: sales_order,\n            custom_farm: farm\n        },\n        fields: [\"name\", \"docstatus\"]\n        \n    });\n    \n    const isSubmitted = existingFPL.some(fpl => fpl.docstatus === 1);\n    \n    if (isSubmitted) {\n        frappe.throw(\"Farm Pack List already submitted. Check your Order Pick List and scan again\")\n    }\n    \n    \n    if (existingFPL.length > 0) {\n        farmPackListDocId = existingFPL[0].name;\n        await addBunchToFarmPackList(farmPackListDocId, bunchStockEntryName, oplName, farm, box_id, box_label);\n        // frappe.msgprint(`Bunch added to existing Farm Pack List: ${farmPackListDocId}`);\n    } else {\n        await createFarmPackListEntry(bunchStockEntryName, oplName, farm, box_id, box_label, totalBunches);\n    }\n}\n\n\n\nasync function createFarmPackListEntry(bunchStockEntryName, oplName, farm, box_id, box_label, totalBunches) {\n    try {\n        const orderId = oplName;\n        const stockEntryId = bunchStockEntryName;\n        \n        // Fetch Sales Order & Stock Entry\n        const orderPick = await frappe.db.get_doc(\"Order Pick List\", orderId);\n        \n        const stockEntry = await frappe.db.get_doc(\"Stock Entry\", stockEntryId);\n    \n        if (!orderPick || !stockEntry || !stockEntry.items.length) {\n            frappe.throw(\"Invalid Sales Order or Stock Entry data\");\n        }\n    \n        \n        \n        const itemCode = stockEntry.items[0].item_code;\n        const uom = stockEntry.items[0].uom;\n        const stem_length = stockEntry.custom_stem_length;\n        \n        // Quantity scanned should always be one per scan\n        const quantity = 1;\n        const customerId = orderPick.customer;\n        const sales_order_id = orderPick.sales_order;\n        \n        \n        const sourceWarehouse = `${farm} Graded Sold - KR`;\n        // Check the opl for the row that matches the variety \n    \n        \n        \n        const stem_from_bunch = {\n            \"Bunch (5)\": 5,\n            \"Bunch (6)\": 6,\n            \"Bunch (10)\": 10,\n            \"Bunch (12)\": 12,\n            \"Bunch (25)\": 25,\n        } \n        \n        const bunch_stems = stem_from_bunch[uom];\n\n        // Get box id from box label\n        // const boxLabelDoc = await frappe.db.get_doc('Box Label', boxStickerDocId);\n        // const boxId = boxLabelDoc.box_number;\n        \n        // Create new Farm Pack List document\n        const packListDoc = frappe.model.get_new_doc(\"Farm Pack List\");\n        packListDoc.custom_sales_order = sales_order_id;\n        packListDoc.custom_farm = farm;\n        \n        const farm_doc = await frappe.db.get_doc(\"Farm\", farm);\n        packListDoc.company = farm_doc.company\n        \n        packListDoc.custom_order_pick_list = orderId;\n        packListDoc.custom_picked_total_stems = totalBunches;\n        packListDoc.pack_list_item = [{\n            item_code: itemCode,\n            bunch_uom: uom,\n            bunch_qty: quantity,\n            source_warehouse: sourceWarehouse,\n            sales_order_id: sales_order_id,\n            customer_id: customerId,\n            custom_number_of_stems: bunch_stems,\n            stem_length: stem_length,\n            box_id: box_id,\n            custom_box_label: box_label,\n            custom_opl_id: orderId,\n        }];\n        \n        // Save document\n        const savedDoc = await frappe.db.insert(packListDoc);\n        \n        farmPackListDocId = savedDoc.name;\n    \n        // frappe.msgprint(\"Farm Pack List entry created successfully!\");\n    } catch (error) {\n        console.error(\"Error saving Farm Pack List:\", error);\n        frappe.throw(`Error saving Farm Pack List: ${error.message}`);\n    }\n    \n} \n\n\n\nasync function addBunchToFarmPackList(farmPackListDocId, bunchStockEntryName, oplName, farm, box_id, box_label) {\n    \n    // Get box id from box label\n    // const boxLabelDoc = await frappe.db.get_doc('Box Label', boxStickerDocId);\n    // const boxId = boxLabelDoc.box_number;\n    // If box Id is different from the existing one and variety is same, place it on another row\n    try {\n        await frappe.call({\n            method: 'upande_kaitet.server_scripts.update_farm_pack_list.add_bunch_to_farm_pack_list',\n            args: {\n                farm_pack_list_doc_id: farmPackListDocId,\n                bunch_SE_name: bunchStockEntryName,\n                opl_name: oplName, \n                farm: farm,\n                box_id: box_id,\n                box_label: box_label,\n            },\n            callback: function (response) {\n                // frappe.msgprint(`Added bunch to Farm Pack List: ${farmPackListDocId}`);\n            }\n        });\n    } catch (error) {\n        console.error('Error adding bunch to Farm Pack List:', error);\n        frappe.throw(`Error adding bunch to Farm Pack List: ${error}`);\n    }\n}\n\n\n\nasync function getSalesOrderAndFarmFromOPL(oplName) {\n    const oplDoc = await frappe.db.get_doc('Order Pick List', oplName);\n    \n    let farm = \"\";\n\n    // make a doctype to map\n    const abbr_mapping = {\n        \"Ravine\": \"Kapkolia\",\n        \"Karen\": \"Karen\",\n    }\n    \n    const farmName = oplDoc.locations[0].warehouse?.split(\" \")[0]\n                    || oplDoc.source_warehouse?.split(\" \")[0]\n                    || oplDoc.locations[0].custom_source_warehouse?.split(\" \")[0]\n                    || \"Unknown\";\n                    \n    \n    if(farmName == \"Ravine\" || farmName == \"Karen\") {\n        farm = abbr_mapping[farmName]\n    } else {\n        farm = farmName\n    }\n    \n    return {\n        sales_order: oplDoc.sales_order,\n        farm: farm\n    };\n}\n\nasync function validateLabels(oplName, bunchLabelData, scannedItems, frm) {\n    const { sales_order, farm } = await getSalesOrderAndFarmFromOPL(oplName);\n    let orderPickVariety;\n    let stockEntryUOM;\n    let stockEntryVariety;\n    \n    // Total bunches should be fetched from the OPL row for the variety\n    let totalBunches = 0;\n    let scannedBunches = 0;\n    let box_number = 0;\n    let box_label = \"\";\n    \n    const bunchData = JSON.parse(bunchLabelData);\n    \n    try {\n        stockEntryVariety = bunchData.variety;\n        stockEntryUOM = bunchData.bunch_size;\n    } catch (error) {\n        frappe.throw(`Error fetching bunch data: ${error}`);\n    }\n    \n    const existingFPL = await frappe.db.get_list(\"Farm Pack List\", {\n        filters: {\n            custom_sales_order: sales_order,\n            custom_farm: farm\n        },\n        fields: [\"name\", \"docstatus\"]\n    });\n    \n    const isSubmitted = existingFPL.some(fpl => fpl.docstatus === 1);\n    \n    if (isSubmitted) {\n        frappe.throw(\"Farm Pack List already submitted. Check your Order Pick List and scan again\");\n    }\n    \n    try {\n        const orderPickList = await frappe.db.get_doc(\"Order Pick List\", oplName);\n        \n        if (!orderPickList || !orderPickList.locations || orderPickList.locations.length === 0) {\n            frappe.msgprint(`No valid Order Pick List found for ${oplName}`);\n            return { totalItems: 0, scannedItems: 0, valid: false };\n        }\n        \n        totalBunches = orderPickList.locations.reduce((sum, row) => {\n            return sum + (row.qty || 0);\n        }, 0);\n        \n        frm.set_value('total_bunches', totalBunches);\n        \n        // Find matching rows in OPL for the scanned variety and UOM\n        const matchingOPLRows = orderPickList.locations.filter(row => \n            row.item_code === stockEntryVariety && row.uom === stockEntryUOM\n        );\n        \n        if (matchingOPLRows.length === 0) {\n            frappe.throw(`No matching variety ${stockEntryVariety} with UOM ${stockEntryUOM} found in Order Pick List`);\n            return { totalItems: 0, scannedItems: 0, valid: false };\n        }\n        \n        // Initialize box_id with null to ensure we explicitly set it\n        let box_id = null;\n        \n        if (!existingFPL.length) {\n            // If no existing FPL, use the first matching OPL row's box_id\n            box_id = matchingOPLRows[0].custom_box_id;\n            box_label = matchingOPLRows[0].custom_box_label\n        } else {\n            // Get the FPL document\n            const fplDoc = await frappe.db.get_doc(\"Farm Pack List\", existingFPL[0].name);\n            const fplTable = fplDoc.pack_list_item || [];\n            \n            // Track scanned bunches for each box of this variety+UOM\n            const boxScannedCounts = {};\n            \n            // Count bunches already scanned for each box\n            fplTable.forEach(fplRow => {\n                if (fplRow.item_code === stockEntryVariety && fplRow.bunch_uom === stockEntryUOM && fplRow.custom_opl_id == oplName) {\n                    const boxKey = fplRow.box_id.toString();\n                    boxScannedCounts[boxKey] = (boxScannedCounts[boxKey] || 0) + fplRow.bunch_qty;\n                }\n            });\n            \n            // Find the first box that isn't full\n            for (const oplRow of matchingOPLRows) {\n                const boxKey = oplRow.custom_box_id.toString();\n                const scannedForBox = boxScannedCounts[boxKey] || 0;\n                \n                // If this box has fewer scanned bunches than required\n                if (scannedForBox < oplRow.qty) {\n                    box_id = oplRow.custom_box_id;\n                    box_label = matchingOPLRows[0].custom_box_label\n                    break;\n                }\n            }\n            \n            // If all boxes are full or no box was found\n            if (box_id === null && matchingOPLRows.length > 0) {\n                frappe.msgprint(`All boxes for ${stockEntryVariety} with UOM ${stockEntryUOM} are full.`);\n                // Use the last box as fallback\n                box_id = matchingOPLRows[matchingOPLRows.length - 1].custom_box_id;\n            }\n            \n            // Calculate total scanned bunches\n            fplTable.forEach(row => {\n                scannedBunches += row.bunch_qty;\n            });\n            \n            // Check if all required bunches for this variety are already scanned\n            const requiredBunchesForVariety = matchingOPLRows.reduce((sum, row) => sum + (row.qty || 0), 0);\n            const scannedBunchesForVariety = fplTable\n                .filter(row => row.item_code === stockEntryVariety && row.bunch_uom === stockEntryUOM && row.custom_opl_id == oplName)\n                .reduce((sum, row) => sum + (row.bunch_qty || 0), 0);\n                \n            if (scannedBunchesForVariety >= requiredBunchesForVariety) {\n                frappe.msgprint(`Excess ${stockEntryVariety} scanned for this order`);\n                return { totalItems: totalBunches, scannedItems: scannedBunches, valid: false };\n            }\n        }\n        \n        // Verify the scanned variety matches an expected variety in OPL\n        for (let i = 0; i < orderPickList.locations.length; i++) {\n            let currVariety = orderPickList.locations[i].item_code;\n            let currUOM = orderPickList.locations[i].uom;\n            \n            if (currVariety === stockEntryVariety) {\n                orderPickVariety = currVariety;\n                \n                if (currUOM !== stockEntryUOM) {\n                    frappe.throw(`Scanned wrong bunch size ${currVariety}: Expected ${currUOM}, but scanned ${stockEntryUOM}`);\n                }\n            }\n        }\n        \n        // Make sure box_id is always set\n        if (box_id === null) {\n            frappe.throw(`Could not determine appropriate box ID for ${stockEntryVariety}`);\n            return { totalItems: totalBunches, scannedItems: scannedBunches, valid: false };\n        }\n        \n        // Set box_number to the determined box_id\n        box_number = box_id;\n        \n    } catch (error) {\n        frappe.throw(`Error processing data: ${error}`);\n    }\n    \n    return {\n        totalItems: totalBunches,\n        scannedItems: scannedBunches,\n        box_number: box_number,\n        box_label: box_label,\n        valid: orderPickVariety === stockEntryVariety\n    };\n}\n\n\n\nfunction toggle_scan_data_field(frm) {\n    if (frm.doc.farm && frm.doc.action) {\n        frm.set_df_property('scan_data', 'hidden', 0);\n        \n        setTimeout(() => {\n            frm.fields_dict.scan_data.$wrapper.find('input').focus();\n        }, 300);\n\n    } else {\n        frm.set_df_property('scan_data', 'hidden', 1);\n    }\n}\n\n\n\nasync function createStockEntry(scan_value, farm, action, audio) {\n    \n    \n\n    let variety;\n    let qty;\n    let grower;\n    let uom;\n    let harvester;\n    let greenhouse;\n    let block__bed_number;\n    let stockEntryDoc;\n    let buckt_id;\n    \n    // Use the stockEntryName to get the stock_entry_data field data needed for\n    // stock transfer\n    if (action == \"Receiving\") {\n        try {\n            const parsed = JSON.parse(scan_value);\n            const keys_array = Object.keys(parsed);\n            const bucket_id = keys_array.find(key => parsed[key] === \"bucket\");\n            \n            \n            \n            const bkt_id_doc = await frappe.db.get_doc(\"Bucket QR Code\", bucket_id);\n        \n            if (bkt_id_doc.status == \"Available\") {\n                \n                frappe.throw(`Bucket ID ${bucket_id} is empty.`);\n                \n            }\n            \n            stockEntryDoc = await frappe.db.get_doc('Stock Entry', bkt_id_doc.last_stock_entry);\n            \n            if (stockEntryDoc.custom_scanned ) {\n                frappe.throw(\"Bucket already scanned!\");\n                \n                return;\n            }\n            \n            const items = stockEntryDoc.items;\n            greenhouse = stockEntryDoc.custom_greenhouse;\n            harvester = stockEntryDoc.custom_harvester_payroll_number;\n            block__bed_number = stockEntryDoc.custom_block__bed_number;\n            buckt_id = bucket_id;\n            \n            if (Array.isArray(items) && items.length > 0) {\n                variety = items[0].item_code;\n                qty = items[0].qty;\n            }\n            \n            \n            frappe.msgprint(`Harvester: ${harvester}, Greenhouse: ${greenhouse}, Bay: ${block__bed_number}, No. of Stems: ${qty} `)\n           \n        } catch (error) {\n            if (error.includes(\"Bucket already scanned!\")) {\n                console.log(error);\n            }\n            frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n        }\n        \n        \n    }\n    \n    if (action === \"Packing\") {\n        const stockEntryName = scan_value;\n        \n        try {\n            stockEntryDoc = await frappe.db.get_doc('Stock Entry', stockEntryName);\n\n        } catch (error) {\n            frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n        }\n        \n        const items = stockEntryDoc.items;\n        \n        items.forEach((item) => {\n            variety = item.item_code;\n            \n            // Flowers are packed per 1 bunch\n            qty = 1;\n            uom = item.uom;\n        });\n        \n\n    }\n    \n    if (action === 'Receiving Quarantined') {\n        try {\n            const parsed = JSON.parse(scan_value);\n            const keys_array = Object.keys(parsed);\n            const bucket_id = keys_array.find(key => parsed[key] === \"bucket\");\n            \n            const bkt_id_doc = await frappe.db.get_doc(\"Bucket QR Code\", bucket_id);\n        \n            if (bkt_id_doc.status == \"Available\") {\n                \n                frappe.throw(`Bucket ID ${bucket_id} is empty.`);\n                \n            }\n            \n            stockEntryDoc = await frappe.db.get_doc('Stock Entry', bkt_id_doc.last_stock_entry);\n            \n            if (stockEntryDoc.custom_scanned ) {\n                frappe.throw(\"Bucket already scanned!\");\n                return;\n            }\n            \n            const items = stockEntryDoc.items;\n        \n            greenhouse = stockEntryDoc.custom_greenhouse;\n            harvester = stockEntryDoc.custom_harvester;\n            block__bed_number = stockEntryDoc.custom_block__bed_number;\n            buckt_id = bucket_id;\n    \n            if (Array.isArray(items) && items.length > 0) {\n                variety = items[0].item_code;\n                qty = items[0].qty;\n            }\n            \n            frappe.msgprint(`Harvester: ${harvester}, Greenhouse: ${greenhouse}, Bay: ${block__bed_number}, No. of Stems: ${qty} `)\n            \n        } catch (error) {\n            if (error.includes(\"Bucket already scanned!\")) {\n                console.log(error);\n            }\n            \n            frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n        }\n        \n        \n    }\n    \n    const stock_entry_type_mapping = {\n        \"Receiving\": \"Receiving\",\n        \"Receiving Quarantined\": \"Receiving Quarantined\",\n    };\n    \n    const stock_entry_type = stock_entry_type_mapping[action];\n    \n    // Get the mapping for the farm\n    const farm_mapping_doc = await frappe.db.get_doc(\"Scan Location Mapping\", `${farm}-MAP`);\n    const mapping_items = farm_mapping_doc.items;\n    \n    const row_array = mapping_items.filter(item => item.action == action);\n    \n    // Check current time to determine target warehouse\n    const currentTime = new Date();\n    const currentHour = currentTime.getHours();\n    const is_after_2pm = currentHour >= 14; // 14:00 is 2 PM in 24-hour format\n    \n    // Determine target warehouse based on time\n    let target_warehouse;\n    if (is_after_2pm) {\n        target_warehouse = `${farm} Holding Store - KR`;\n    } else {\n        target_warehouse = row_array[0].target_warehouse;\n    }\n    \n    // Change the mapping of the location to check the location doctype \n    const locationMapping = {\n        [`${farm} Receiving`]: { source: `${greenhouse}`, target: target_warehouse },\n        [`${farm} Receiving Quarantined`]: { source: `${greenhouse}`, target: target_warehouse },\n    };\n    \n    const scanLocation = `${farm} ${action}`;\n    \n    const stockmvt = locationMapping[scanLocation];\n    \n    const farm_doc = await frappe.db.get_doc(\"Farm\", farm);\n    const company = farm_doc.company;\n    \n    if (!stockmvt) {\n        frappe.msgprint(`Invalid scan location: ${scanLocation}`);\n        return;\n    }\n    \n    stock_entry_data = {\n        \"location data\": stockmvt,\n        \"variety\": variety,\n        \"quantity\": qty,\n        \"grower\": grower,\n        \"harvester\": harvester,\n        \"greenhouse\": greenhouse,\n        \"stock entry type\": stock_entry_type,\n        \"uom\": uom,\n        \"block__bed_number\": block__bed_number,\n        \"bucket_id\": buckt_id,\n        \"farm\": farm,\n        \"business_unit\": \"Roses\",\n        \"company\": company\n    };\n        \n    \n\n    const created_stock_entry = await frappe.call({\n        method: \"upande_kaitet.server_scripts.create_stock_entry.create_stock_entry\",\n        args: {\n            stock_entry_data: JSON.stringify(stock_entry_data),\n        }\n    });\n    \n    if (!created_stock_entry.message || !created_stock_entry.message.includes(\"SE\")) {\n        frappe.throw(\"Stock Entry Failed\");\n    }\n\n    if ( created_stock_entry.message.includes(\"SE\") && (stock_entry_type == \"Receiving\" || stock_entry_type == \"Receiving Quarantined\") ) {\n        await frappe.call({\n            method: \"upande_kaitet.server_scripts.update_custom_scanned.update_custom_scanned\",\n            args: { \n                stock_entry_name: stockEntryDoc.name,\n                action: action,\n                oplName: null\n            }\n        });\n        \n        audio.play();\n    }\n\n    return created_stock_entry;\n\n}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Scan",
  "enabled": 1,
  "modified": "2025-02-26 08:46:32.942181",
  "module": "Upande Kaitet",
  "name": "Close Box Button",
  "script": "frappe.ui.form.on('Scan', {\n\trefresh: function(frm) {\n        update_primary_action(frm);\n        toggle_order_pick_list(frm)\n    },\n\n    action: function(frm) {\n        update_primary_action(frm);\n        toggle_order_pick_list(frm)\n    },\n\n    farm: function(frm) {\n        update_primary_action(frm);\n    },\n    \n    opl_data: function(frm) {\n        update_primary_action(frm);\n    },\n    \n    scan_data: function(frm) {\n        update_primary_action(frm);\n    }\n});\n\n\nfunction toggle_order_pick_list(frm) {\n    frm.toggle_display('order_pick_list', frm.doc.action === 'Packing');\n    frm.toggle_display('status', frm.doc.action === 'Packing');\n}\n\n\nfunction update_primary_action(frm) {\n    // if (frm.doc.status === 'Paused') {\n    //     frm.page.set_secondary_action('Resume Scan', function() {\n    //         frm.save().then(() => {\n    //             update_primary_action(frm);\n    //         });\n    //     });\n    // }\n    \n    if (frm.doc.action === 'Packing') {\n        if (frm.doc.status === 'Paused') {\n            frm.page.set_primary_action('Close Box', function() {\n                frm.set_value('status', 'Closed');\n                saveDoc(frm); \n            });\n        } else if (frm.doc.__unsaved) {\n            frm.page.set_primary_action('Pause Box', function() {\n                frm.set_value('status', 'Paused');\n                frm.save().then(() => {\n                    update_primary_action(frm);\n                });\n            });\n        } else {\n            frm.page.set_primary_action('Pause Box', function() {\n                frm.set_value('status', 'Paused');\n                frm.save().then(() => {\n                    update_primary_action(frm);\n                });\n            });\n        }\n            \n    } else {\n        frm.page.set_primary_action(__('Save'), function() {\n            frm.save();\n        });\n    }\n}\n\nfunction saveDoc(frm) {\n    frappe.call({\n        method: \"frappe.client.submit\",\n        args: {\n            doc: frm.doc,\n        },\n        callback: function(response) {\n            frappe.msgprint(\"Box Closed!\");\n            frm.reload_doc();\n        }\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 0,
  "modified": "2025-03-13 02:53:00.320459",
  "module": "Upande Kaitet",
  "name": "Transfer Grading Stock",
  "script": "frappe.listview_settings['Stock Entry'] = {\r\n    onload: function(listview) {\r\n        listview.page.add_button('Transfer Graded Stock', () => {\r\n            // Get all stock entries from the list that were created in the last 24 hours\r\n            let selected_entries = listview.data.filter(entry => {\r\n                let entryDate = new Date(entry.creation);\r\n                let last24Hours = new Date();\r\n                last24Hours.setHours(last24Hours.getHours() - 24);\r\n\r\n                return (\r\n                    entry.docstatus === 1 &&\r\n                    entryDate >= last24Hours && \r\n                    [\"Grading\", \"Grading Without Receiving\"].includes(entry.stock_entry_type)\r\n                );\r\n            }).map(entry => entry.name);\r\n            \r\n            if (selected_entries.length === 0) {\r\n                frappe.msgprint(__('No recent graded stock entries found.'));\r\n                return;\r\n            }\r\n\r\n            // Call the API to process the stock transfer\r\n            frappe.call({\r\n                method: \"upande_kaitet.server_scripts.transfer_graded_stock.transfer_stock\",\r\n                args: { stock_entries: selected_entries },\r\n                freeze: true,\r\n                freeze_message: \"Processing stock transfer...\",\r\n                callback: function(response) {\r\n\r\n                    if (response.message) {\r\n                        frappe.msgprint(`Stock Transfers Created: ${response.message.transferred_entries.join(\", \")}`);\r\n                        listview.refresh();\r\n                    } else {\r\n                        frappe.msgprint(\"Failed to create stock transfers.\");\r\n                    }\r\n                }\r\n            });\r\n\r\n        }, 'Action');\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Harvest",
  "enabled": 1,
  "modified": "2025-03-13 01:51:12.116581",
  "module": "Upande Kaitet",
  "name": "New Form After Save",
  "script": "frappe.ui.form.on('Harvest', {\n    after_save: function(frm) {\n        frappe.show_alert({message: 'Saved successfully!', indicator: 'green'});\n        \n        // Refresh and open a new form\n        setTimeout(() => {\n            frappe.set_route('Form', frm.doctype, 'new');\n        }, 1000);\n        \n        setTimeout(() => {\n            window.location.reload();\n        }, 1000);\n        \n        \n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Label Print",
  "enabled": 1,
  "modified": "2025-03-19 15:37:52.775509",
  "module": "Upande Kaitet",
  "name": "Remove Read Only on Field",
  "script": "frappe.ui.form.on('Label Print', {\n\tvariety(frm) {\n\t    if (frm.doc.variety) {\n            frappe.db.get_value('Item', frm.doc.variety, 'sales_uom', (r) => {\n                if (r && r.sales_uom) {\n                    frm.set_value('bunch_size', r.sales_uom);\n                }\n            });\n        }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Harvest",
  "enabled": 1,
  "modified": "2025-06-08 07:30:56.628089",
  "module": "Upande Kaitet",
  "name": "Ensure Bucket Is Scanned On Save",
  "script": "frappe.ui.form.on('Harvest', {\n\tbefore_save(frm) {\n\t\tif (!frm.doc.bucket_id) {\n\t\t    frappe.throw(\"Please Refresh and scan the bucket QR Code before saving!\");\n\t\t    \n\t\t    \n\t\t    setTimeout(() => {\n                frappe.set_route('Form', frm.doctype, 'new');\n            }, 4000);\n            \n            setTimeout(() => {\n                window.location.reload();\n            }, 1000);\n\t\t}\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Label Print",
  "enabled": 0,
  "modified": "2025-06-09 12:28:37.599377",
  "module": "Upande Kaitet",
  "name": "Grading Traceability Symbols",
  "script": "frappe.ui.form.on('Label Print', {\n\trefresh(frm) {\n\t    let creation_date = frappe.datetime.now_date();\n\t    let date_obj = new Date(creation_date);\n\t    let day_index = date_obj.getDay();\n\t    \n\t    const days_of_week = [\"Sunday\", \"Monday\", \"Tuesday\", \"Wednesday\", \"Thursday\", \"Friday\", \"Saturday\"];\n\t    const sign = [\"+\", \"#\", \"@\", \"*\", \"$\", \"%\", \"&\"];\n\t    \n\t    let day_of_week = days_of_week[day_index];\n\t    let day_sign = sign[day_index];\n\t    \n\t    \n\t    frm.set_value(\"day_code\", day_sign);\n\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bunch QR Code",
  "enabled": 1,
  "modified": "2025-04-08 16:08:27.672356",
  "module": null,
  "name": "Set List View Limit to 500(BUNCH)",
  "script": "frappe.listview_settings[\"Bunch QR Code\"] = {\n    refresh:  function(listview) {\n        listview.page_length = 1000;\n        listview.start = 0;\n        listview.refresh();\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bucket QR Code",
  "enabled": 1,
  "modified": "2025-04-08 16:08:11.873432",
  "module": "Upande Kaitet",
  "name": "Set List View Limit to 500(BUCKET)",
  "script": "frappe.listview_settings[\"Bucket QR Code\"] = {\n    refresh:  function(listview) {\n        listview.page_length = 1000;\n        listview.start = 0;\n        listview.refresh();\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Consolidated Pack List",
  "enabled": 1,
  "modified": "2025-04-22 13:08:55.028711",
  "module": "Upande Kaitet",
  "name": "Autopopulate Sales Order ID in CPL",
  "script": "frappe.ui.form.on('Dispatch Form Item', {\n\titems_add(frm, cdt, cdn) {\n\t\tlet row = locals[cdt][cdn];\n\t\t\n\t\tif (frm.doc.custom_sales_order_id_cpl) {\n\t\t    row.sales_order_id = frm.doc.custom_sales_order_id_cpl;\n\t\t    row.customer_id = frm.doc.custom_customer;\n\t\t    \n\t\t    frm.refresh_field('items');\n\t\t}\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bunch QR Code",
  "enabled": 1,
  "modified": "2025-04-12 10:40:41.407428",
  "module": "Upande Kaitet",
  "name": "Hide Filter Button 2",
  "script": "frappe.listview_settings[\"Bunch QR Code\"] = {\n    onload(listview) {\n        setTimeout(() => {\n            let filter_button = $(\".filter-section .filter-selector\");\n            \n            if (filter_button.length) {\n                \n                filter_button.hide();\n            }\n        }, 2000);\n        \n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Bucket QR Code",
  "enabled": 0,
  "modified": "2025-06-09 12:02:00.774065",
  "module": "Upande Kaitet",
  "name": "Hide Filter Button (Bucket QR Code List) 2",
  "script": "frappe.listview_settings['Bucket QR Code'] = {\n    onload(listview) {\n        setTimeout(() => {\n            let filter_button = $('.filter-section .filter-selector');\n            \n            if (filter_button.length) {\n                filter_button.hide();\n            }\n        }, 500);\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Farm Pack List",
  "enabled": 1,
  "modified": "2025-04-16 15:23:34.287546",
  "module": "Upande Kaitet",
  "name": "Ensure Items are in SO Before Manually Adding (FPL)",
  "script": "frappe.ui.form.on('Dispatch Form Item', {\n\tasync item_code(frm, cdt, cdn) {\n\t\tlet row = locals[cdt][cdn];\n\t\tlet item = 0;\n\t\t\n\t\ttry {\n            const salesOrderDoc = await frappe.db.get_doc(\"Sales Order\", frm.doc.custom_sales_order);\n            const itemsList = salesOrderDoc.items;\n            \n            for(let i = 0; i < itemsList.length; i++) {\n                if(itemsList[i].item_code == row.item_code) {\n                    item = 1;\n                }\n            }\n            \n            if (item == 0) {\n                frappe.msgprint(`${row.item_code} not found in Sales Order`);\n                row.item_code = \"\";\n            }\n            \n\t\t} catch (e) {\n\t\t    frappe.throw(`Error comparing with Sales Order, ${e}`);\n\t\t}\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Farm Pack List",
  "enabled": 0,
  "modified": "2025-07-03 18:48:00.326457",
  "module": "Upande Kaitet",
  "name": "Authorise Under Pack Button in FPL",
  "script": "frappe.ui.form.on('Farm Pack List', {\n    refresh: function(frm) {\n        // Check if document is in Draft state and is underpacked\n        if (frm.doc.workflow_state === 'Draft' && frm.doc.custom_completion_percentage < 100) {\n            // Add the \"Authorise Under Pack\" button\n            frm.add_custom_button(__('Authorise Under Pack'), function() {\n                // Check if Under Pack Reason is provided\n                if (!frm.doc.custom_under_pack_reason || frm.doc.custom_under_pack_reason.trim() === '') {\n                    frappe.throw(__('Please provide a reason for under packing before requesting authorization'));\n                    return;\n                }\n                // Call server method to request authorization\n                frappe.call({\n                    method: 'upande_kaitet.server_scripts.under_packing.request_under_pack_authorization',\n                    args: {\n                        'doc_name': frm.doc.name\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.show_alert({\n                                message: __('Under Pack Authorization Requested Successfully'),\n                                indicator: 'green'\n                            }, 5);\n                            frm.reload_doc();\n                        }\n                    }\n                });\n            }).addClass('btn-primary');\n        }\n\n        // For Sales Manager - Show dropdown button if authorization is pending\n        if (frm.doc.workflow_state === 'Pending Order Review' && frm.doc.custom_completion_percentage < 100 && frappe.user.has_role('Sales Manager')) {\n            // Create a dropdown button \"Under Packed\"\n            frm.add_custom_button(__(''), function() {\n                // This is a placeholder function since we'll be using the dropdown functionality\n            }, __('Under Packed Button')).addClass('btn-primary');\n\n            // Add \"Approve Under Pack\" option to the dropdown\n            frm.add_custom_button(__('Approve Under Pack'), function() {\n                frappe.call({\n                    method: 'upande_kaitet.server_scripts.under_packing.approve_under_pack',\n                    args: {\n                        'doc_name': frm.doc.name\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.show_alert({\n                                message: __('Under Pack Approved Successfully'),\n                                indicator: 'green'\n                            }, 5);\n                            frm.reload_doc();\n                        }\n                    }\n                });\n            }, __('Under Packed Button'));\n\n            // Add \"Reject Under Pack\" option to the dropdown\n            frm.add_custom_button(__('Reject Under Pack'), function() {\n                frappe.call({\n                    method: 'upande_kaitet.server_scripts.under_packing.reject_under_pack',\n                    args: {\n                        'doc_name': frm.doc.name\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.show_alert({\n                                message: __('Under Pack Rejected'),\n                                indicator: 'red'\n                            }, 5);\n                            frm.reload_doc();\n                        }\n                    }\n                });\n            }, __('Under Packed Button'));\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-07-03 21:24:10.754573",
  "module": "Upande Kaitet",
  "name": "Create Delivery Note Button",
  "script": "frappe.ui.form.on('Material Request', {\n\trefresh(frm) {\n\t\tif (frm.doc.material_request_type === 'Material Transfer' && \n            frm.doc.docstatus === 1) {\n            \n            frm.add_custom_button(__('Delivery Note'), function() {\n                create_delivery_note(frm);\n            }, __('Create'));\n            \n        }\n\t}\n})\n\nfunction create_delivery_note(frm) {\n\n    frappe.model.with_doctype('Delivery Note', function() {\n        let delivery_note = frappe.model.get_new_doc('Delivery Note');\n        \n        delivery_note.company = frm.doc.company;\n        delivery_note.posting_date = frappe.datetime.get_today();\n        delivery_note.set_posting_time = 0;\n        delivery_note.material_request = frm.doc.name;\n        delivery_note.customer = frm.doc.customer || 'Yoghurt Dispatch';\n        delivery_note.custom_farm = frm.doc.custom_farm;\n        delivery_note.custom_business_unit = frm.doc.custom_business_unit;\n        delivery_note.custom_location = 'Ravine';\n        delivery_note.custom_delivery_type = 'Yoghurt Dispatch';\n        \n        \n        // Map items from Material Request to Delivery Note\n        frm.doc.items.forEach(function(item) {\n            let delivery_item = frappe.model.add_child(delivery_note, 'items');\n            delivery_item.item_code = item.item_code;\n            delivery_item.item_name = item.item_name;\n            delivery_item.qty = item.qty;\n            delivery_item.uom = item.uom;\n            delivery_item.warehouse = item.warehouse;\n            delivery_item.material_request = frm.doc.name;\n            delivery_item.material_request_item = item.name;\n        });\n        \n        // Open the new Delivery Note for editing\n        frappe.set_route('Form', 'Delivery Note', delivery_note.name);\n        \n        frappe.msgprint(__(\"Delivery Note created. Please complete the remaining details and save.\"));\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-06-22 19:55:15.063372",
  "module": "Upande Kaitet",
  "name": "Autopopulate Farm and Business Unit (SO)",
  "script": "frappe.ui.form.on('Sales Order', {\n\tcustom_sales_order_type: function (frm) {\n\t\tif (frm.doc.custom_sales_order_type == \"Yoghurt\") {\n\t\t    frm.set_value(\"company\" ,\"Karen Roses\");\n\t\t    frm.set_value(\"custom_farm\", \"Karen\");\n\t\t    frm.set_value(\"custom_business_unit\" ,\"Westwood Yoghurt\")  ;\n\t\t}\n\t\t\n\t\tif (frm.doc.custom_sales_order_type == \"Roses\" ) {\n\t\t    frm.set_value(\"company\" ,\"Karen Roses\");\n\t\t    frm.set_value(\"custom_farm\", \"\");\n\t\t    \n\t\t    frm.set_value(\"custom_business_unit\" ,\"Roses\");\n\t\t}\n\t\t\n\t\tfrm.refresh_field(\"items\");\n\t\t\n\t\tfrm.fields_dict.items.grid.refresh();\n\n\t\tfrm.doc.items.forEach(function(item, index) {\n\t\t\tfrm.fields_dict.items.grid.grid_rows[index].refresh();\n\t\t});\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Dispatch Form",
  "enabled": 1,
  "modified": "2025-06-17 06:31:27.310321",
  "module": "Upande Kaitet",
  "name": "Fetch SO Details",
  "script": "frappe.ui.form.on('Dispatch Form', {\n\tasync custom_sales_order(frm) {\n        try {\n            const so_doc = await frappe.db.get_doc(\"Sales Order\", frm.doc.custom_sales_order);\n            const so_doc_items = so_doc.items;\n            \n            frm.clear_table(\"dispatch_form_item\");\n            \n            // fetch dynamically from the item\n            const source_wh = \"Ravine Graded Sold - KR\";\n            \n            so_doc_items.forEach(so_item => {\n                \n                \n                let dispatch_item = frm.add_child(\"dispatch_form_item\");\n                \n                // Map fields from Sales Order item to Dispatch Form item\n                dispatch_item.item_code = so_item.item_code;\n                dispatch_item.item_name = so_item.item_name;\n                dispatch_item.bunch_qty = so_item.qty;\n                dispatch_item.bunch_uom = so_item.uom;\n                dispatch_item.source_warehouse = source_wh;\n                dispatch_item.custom_box_label = so_item.custom_box_label;\n                dispatch_item.delivery_point = so_item.custom_delivery_point;\n                dispatch_item.sales_order_id = so_doc.name;\n\n            });\n            \n            frm.doc.company = so_doc.company;\n            \n            frm.doc.custom_farm = so_doc.custom_farm;\n            frm.doc.custom_business_unit = so_doc.custom_business_unit;\n            frm.doc.custom_customer = so_doc.customer;\n            \n            // Refresh the child table to show the new items\n            frm.refresh_field(\"dispatch_form_item\");\n            frm.refresh();\n\n            // Optional: Show success message\n            frappe.show_alert({\n                message: `${so_doc_items.length} items loaded from Sales Order`,\n                indicator: 'green'\n            });\n            \n            \n        } catch(e) {\n            frappe.throw(`Error getting sales order doc ${e}`);\n        }\n        \n        \n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 0,
  "modified": "2025-06-22 21:01:55.185053",
  "module": "Upande Kaitet",
  "name": "Yoghurt Delivery Workflow",
  "script": "frappe.ui.form.on('Delivery Note', {\n    refresh: function(frm) {\n        // Handle Pending Approval state\n        if (frm.doc.workflow_state === 'In Transit Awaiting Approval') {\n            // Hide default workflow buttons\n            setTimeout(() => {\n                $('.btn-workflow').hide();\n            }, 100);\n            \n            add_approval_buttons(frm);\n        }\n        \n        // Handle Approved state - show End Trip button\n        if (frm.doc.workflow_state === 'Approved') {\n            frm.add_custom_button(__('End Trip'), function() {\n                frappe.confirm(\n                    'Are you sure you want to end this trip?',\n                    () => {\n                        frappe.xcall('your_custom_app.delivery_workflow.end_trip', {\n                            docname: frm.doc.name\n                        }).then(r => {\n                            frm.reload_doc();\n                            frappe.show_alert({\n                                message: __('Trip completed successfully!'),\n                                indicator: 'green'\n                            });\n                        });\n                    }\n                );\n            }).addClass('btn-primary');\n        }\n        \n        // Show approval status dashboard\n        show_approval_status(frm);\n    }\n});\n\n\nfunction add_approval_buttons(frm) {\n    let user_roles = frappe.user_roles;\n    \n    frappe.throw(\"reached here\")\n    \n    // Kapkolia Store Approval Button\n    if (user_roles.includes('Kapkolia Store Manager')) {\n        if (!frm.doc.kapkolia_store_approved) {\n            frm.add_custom_button(__('Approve - Kapkolia Store'), function() {\n                approve_delivery(frm, 'kapkolia_store_approved', 'Kapkolia Store');\n            }).addClass('btn-success');\n        } else {\n            frm.add_custom_button(__('✓ Kapkolia Store Approved'), function() {\n                frappe.msgprint('Already approved by Kapkolia Store');\n            }).addClass('btn-default').attr('disabled', true);\n        }\n    }\n    \n    // Kapkolia Security Approval Button\n    if (user_roles.includes('Kapkolia Security Officer')) {\n        if (!frm.doc.kapkolia_security_approved) {\n            frm.add_custom_button(__('Approve - Kapkolia Security'), function() {\n                approve_delivery(frm, 'kapkolia_security_approved', 'Kapkolia Security');\n            }).addClass('btn-success');\n        } else {\n            frm.add_custom_button(__('✓ Kapkolia Security Approved'), function() {\n                frappe.msgprint('Already approved by Kapkolia Security');\n            }).addClass('btn-default').attr('disabled', true);\n        }\n    }\n    \n    // Karen Store Approval Button\n    if (user_roles.includes('Karen Store Manager')) {\n        if (!frm.doc.karen_store_approved) {\n            frm.add_custom_button(__('Approve - Karen Store'), function() {\n                approve_delivery(frm, 'karen_store_approved', 'Karen Store');\n            }).addClass('btn-success');\n        } else {\n            frm.add_custom_button(__('✓ Karen Store Approved'), function() {\n                frappe.msgprint('Already approved by Karen Store');\n            }).addClass('btn-default').attr('disabled', true);\n        }\n    }\n    \n    // Karen Security Approval Button\n    if (user_roles.includes('Karen Security Officer')) {\n        if (!frm.doc.karen_security_approved) {\n            frm.add_custom_button(__('Approve - Karen Security'), function() {\n                approve_delivery(frm, 'karen_security_approved', 'Karen Security');\n            }).addClass('btn-success');\n        } else {\n            frm.add_custom_button(__('✓ Karen Security Approved'), function() {\n                frappe.msgprint('Already approved by Karen Security');\n            }).addClass('btn-default').attr('disabled', true);\n        }\n    }\n    \n    // Reject Button (available to all approvers and System Manager)\n    if (user_roles.includes('System Manager') || \n        user_roles.includes('Kapkolia Store Manager') ||\n        user_roles.includes('Kapkolia Security Officer') ||\n        user_roles.includes('Karen Store Manager') ||\n        user_roles.includes('Karen Security Officer')) {\n        \n        frm.add_custom_button(__('Reject'), function() {\n            reject_delivery(frm);\n        }).addClass('btn-danger');\n    }\n}\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-06-22 19:42:34.327662",
  "module": "Upande Kaitet",
  "name": "Autopopulate Week Number",
  "script": "frappe.ui.form.on('Sales Order', {\n    delivery_date: function(frm) {\n        if (frm.doc.delivery_date) {\n            let date = new Date(frm.doc.delivery_date);\n            let week_number = getWeekNumber(date);\n            frm.set_value('custom_week', week_number);\n        }\n    }\n});\n\nfunction getWeekNumber(date) {\n    // Clone the date to avoid modifying the original\n    let d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\n    \n    // Set to nearest Thursday: current date + 4 - current day number\n    // Make Sunday's day number 7\n    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));\n    \n    // Get first day of year\n    let yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n    \n    // Calculate full weeks to nearest Thursday\n    let weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);\n    \n    return weekNo;\n}",
  "view": "Form"
 }
]